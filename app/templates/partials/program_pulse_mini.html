
{# FF: Logo fallback helper #}
{% set _org_logo = _org_logo|default(url_for('static', filename='images/fundchamps-fc.svg')) %}


<!--
üíé FUTUREFUNDED GO-LIVE CHECKLIST (UI/UX)

1. LOGO wired from Flask context (_org_logo)
2. Accessibility: skiplinks, focus rings, ARIA
3. Responsive test on mobile/tablet/desktop
4. Powered by FutureFunded badge present
5. PWA icons + manifest verified
6. No overflow / no bleed / theme verified
-->

{# =============================================================================
   Program Pulse Mini ‚Äî Elite v2 (slim, CSP-safe, auto-hide)
   ============================================================================= #}
{% set SHOW_PULSE    = SHOW_PULSE    if SHOW_PULSE    is defined else true %}
{% set HIDE_IF_EMPTY = HIDE_IF_EMPTY if HIDE_IF_EMPTY is defined else true %}
{% set SHOW_DEMO     = SHOW_DEMO     if SHOW_DEMO     is defined else false %}

{% if SHOW_PULSE %}
{# CSP nonce macro (coexists safely with your existing helper) #}
{% if nonce_attr is not defined %}
  {% set NONCE = NONCE if NONCE is defined else (csp_nonce if csp_nonce is defined else '') %}
  {% macro nonce_attr() -%}{% if NONCE %}nonce="{{ NONCE }}"{% endif %}{%- endmacro %}
{% endif %}

{# Theme / brand #}
{% set theme_hex = theme_hex|default('#facc15') %}

{# Team logo (Connect ATX Elite default) #}
{% set _raw_connect_logo = (team.logo if team is defined and team.logo is defined and team.logo) or 'images/connect-atx-elite.svg' %}
{% set CONNECT_LOGO = (_raw_connect_logo if _raw_connect_logo.startswith('http') else ((url_for('static', filename=_raw_connect_logo.lstrip('/')) if url_for is defined else '/static/' ~ _raw_connect_logo.lstrip('/')))) %}

{# Data fallbacks (kept small; toggled by SHOW_DEMO) #}
{% set _demo_events = [
  {"date":"2025-07-20","name":"AAU Tournament","location":"East Austin Gym","time":"10:00 AM","type":"Tournament"},
  {"date":"2025-07-22","name":"Team Practice","location":"East Austin Gym","time":"5:00 PM","type":"Practice"},
  {"date":"2025-07-24","name":"League Game","location":"Del Valle HS","time":"7:00 PM","type":"Game"}
] %}
{% set events = (events if events is defined and events else (_demo_events if SHOW_DEMO else [])) %}

{# Sponsors: default to Connect ATX Elite #}
{% set sponsors_sorted = sponsors_sorted if sponsors_sorted is defined and sponsors_sorted else [] %}
{% set display_sponsors = (sponsors_sorted[:10] if sponsors_sorted else [
  {"name":"Connect ATX Elite","logo": CONNECT_LOGO, "url": (team.url if team is defined and team.url is defined else "#")}
]) %}

<section id="program-pulse-mini"
         class="fc-ppm"
         role="complementary"
         aria-labelledby="ppm-heading"
         data-brand="{{ theme_hex }}"
         data-hide="{{ '1' if HIDE_IF_EMPTY else '0' }}"
         data-demo="{{ '1' if SHOW_DEMO else '0' }}">
  <style {{ nonce_attr() }}>
    /* ===== Scoped to #program-pulse-mini ===== */
    #program-pulse-mini{
      --brand: {{ theme_hex }};
      --bg: color-mix(in srgb, #0b0d12 78%, transparent);
      --line: rgba(255,255,255,.12);
      --text: #f5f5f4; --muted:#d4d4d8;
      color: var(--text);
      font: 600 14px/1.4 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    #program-pulse-mini.ppm--hidden{ display:none }
    #program-pulse-mini .ppm-card{
      background: var(--bg);
      border:1px solid var(--line);
      border-radius:1rem;
      -webkit-backdrop-filter: blur(10px) saturate(120%);
      backdrop-filter: blur(10px) saturate(120%);
      box-shadow: 0 12px 32px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.05);
      padding: .9rem; width: 100%; max-width: 480px;
    }
    #program-pulse-mini .ppm-head{ display:flex; align-items:center; gap:.6rem; min-width:0 }
    #program-pulse-mini .chip{
      display:inline-flex; align-items:center; gap:.35rem; padding:.22rem .6rem; border-radius:999px;
      background: rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.16); font-size:.72rem; font-weight:900; text-transform:uppercase;
      letter-spacing:.02em;
    }
    #program-pulse-mini .title{ font-weight:1000; letter-spacing:-.01em; font-size:1rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
    #program-pulse-mini .sub{ color:var(--muted); font-size:.86rem }
    #program-pulse-mini .row{ display:flex; align-items:center; gap:.6rem; flex-wrap:wrap }
    #program-pulse-mini .kbd{ font-variant-numeric:tabular-nums }

    /* Meter-lite */
    #program-pulse-mini .meter{ position:relative; height:10px; border-radius:999px; overflow:hidden; background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.08) }
    #program-pulse-mini .meter .fill{
      position:absolute; inset-block:0; left:0; width:0%;
      background: linear-gradient(90deg, #fffbe6, var(--brand), #f59e0b);
      box-shadow: 0 0 8px color-mix(in srgb, var(--brand) 60%, transparent);
      transition: width .7s cubic-bezier(.2,.8,.2,1)
    }

    /* Buttons */
    #program-pulse-mini .btn{
      display:inline-flex; align-items:center; gap:.4rem; padding:.48rem .7rem; border-radius:.7rem;
      font-weight:900; font-size:.82rem; border:1px solid rgba(255,255,255,.16); background:rgba(255,255,255,.06);
      color:#e7e5e4; text-decoration:none; cursor:pointer
    }
    #program-pulse-mini .btn-brand{
      color:#111827; background:linear-gradient(180deg, #fde047, var(--brand)); border-color: color-mix(in srgb, var(--brand) 60%, transparent);
      box-shadow: 0 8px 20px color-mix(in srgb, var(--brand) 30%, transparent)
    }
    #program-pulse-mini .btn[aria-disabled="true"]{ opacity:.6; pointer-events:none }
    #program-pulse-mini .btn:focus-visible{ outline:2px solid #fff7cc; outline-offset:2px }

    /* Upcoming list */
    #program-pulse-mini details{ margin-top:.6rem }
    #program-pulse-mini summary{
      list-style:none; cursor:pointer; display:flex; align-items:center; justify-content:space-between; gap:.6rem;
      padding:.5rem .6rem; border-radius:.6rem; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.04);
      font-weight:900; font-size:.86rem; user-select:none
    }
    #program-pulse-mini summary::-webkit-details-marker{ display:none }
    #program-pulse-mini .list{ margin-top:.5rem; display:grid; gap:.45rem }
    #program-pulse-mini .item{
      display:grid; grid-template-columns:auto 1fr auto; gap:.6rem; align-items:center;
      padding:.5rem .6rem; border-radius:.6rem; border:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.2);
      font-size:.9rem; min-width:0
    }
    #program-pulse-mini .item .when{ color:#e7e5e4; font-weight:900; min-width:10ch; font-variant-numeric:tabular-nums }
    #program-pulse-mini .item .what{ font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
    #program-pulse-mini .item .where{ color:var(--muted); font-size:.8rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }

    /* Sponsors ribbon */
    #program-pulse-mini .ribbon{ margin-top:.75rem; display:flex; gap:.6rem; overflow:auto hidden; align-items:center }
    #program-pulse-mini .ribbon .logo{
      height:22px; width:auto; background:#fff; border-radius:.4rem; padding:.18rem .36rem;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.06)
    }
    #program-pulse-mini .ribbon a{ display:inline-flex; align-items:center }
    #program-pulse-mini .ribbon::-webkit-scrollbar{ height:6px }
    #program-pulse-mini .ribbon::-webkit-scrollbar-thumb{ background:rgba(255,255,255,.2); border-radius:999px }

    @media (prefers-reduced-motion: reduce){ #program-pulse-mini .meter .fill{ transition:none } }
    @media (max-width:420px){
      #program-pulse-mini .ppm-card{ padding:.8rem }
      #program-pulse-mini .item{ grid-template-columns: 1fr; gap:.3rem; align-items:start }
      #program-pulse-mini .item .when{ min-width:auto }
    }
  </style>

  <div class="ppm-card" aria-live="polite">
    <div class="ppm-head" aria-describedby="ppm-sr">
      <span class="chip" aria-hidden="true">Next Up</span>
      <div class="title" id="ppm-heading">Finding your next event‚Ä¶</div>
    </div>

    <div class="mt-2 sub" id="ppm-sub">‚Äî</div>

    <!-- Countdown + quick add -->
    <div class="mt-3 row" role="group" aria-label="Event actions">
      <div class="chip" aria-live="polite" id="ppm-countdown" title="Time remaining">‚è≥ ‚Äî</div>
      <button type="button" class="btn btn-brand" id="ppm-ics">+ .ics</button>
      <a href="#" class="btn" id="ppm-gcal" rel="noopener">+ Google</a>
      <a href="#program-stats-calendar" class="btn" id="ppm-all">All events ‚Üí</a>
    </div>

    <!-- Mini meter -->
    <div class="mt-3" aria-live="polite" aria-atomic="true">
      <div class="meter" aria-hidden="true"><div class="fill" id="ppm-fill" style="width:0%"></div></div>
      <div class="mt-1 sub">
        <span class="kbd" id="ppm-raised">‚Äî</span> /
        <span class="kbd" id="ppm-goal">‚Äî</span> ¬∑
        <strong id="ppm-pct">0%</strong>
      </div>
    </div>

    <!-- Collapsible upcoming list -->
    <details id="ppm-list">
      <summary aria-controls="ppm-ul">
        Upcoming (<span id="ppm-count">0</span>) ‚Äî Connect ATX Elite
      </summary>
      <div id="ppm-ul" class="list" role="list"></div>
    </details>

    <!-- Sponsors ribbon -->
    <div class="ribbon" aria-label="Sponsors">
      {% for s in display_sponsors %}
        <a href="{{ s.url or '#' }}" target="{{ '_blank' if s.url }}" rel="noopener noreferrer sponsored" class="shrink-0" aria-label="Visit {{ s.name }}">
          <img class="logo" src="{{ s.logo or CONNECT_LOGO }}" alt="{{ s.name }} logo" loading="lazy" decoding="async"/>
        </a>
      {% endfor %}
    </div>

    <span id="ppm-sr" class="sr-only"></span>
  </div>

  <script {{ nonce_attr() }}>
    (() => {
      const ROOT = document.getElementById('program-pulse-mini');
      if (!ROOT || ROOT.__wired) return; ROOT.__wired = true;
      const $ = (sel, r=ROOT) => r.querySelector(sel);

      const saveData = (navigator.connection && navigator.connection.saveData) || false;
      const hideIfEmpty = ROOT.dataset.hide === '1';
      const isDemo = ROOT.dataset.demo === '1';

      // Inputs
      const data = { events: {{ events|tojson }} };

      // Elements
      const heading   = $('#ppm-heading');
      const sub       = $('#ppm-sub');
      const sr        = $('#ppm-sr');
      const countdown = $('#ppm-countdown');
      const icsBtn    = $('#ppm-ics');
      const gcalLink  = $('#ppm-gcal');
      const listWrap  = $('#ppm-ul');
      const listCount = $('#ppm-count');
      const allLink   = $('#ppm-all');

      // Meter bits
      const fill      = $('#ppm-fill');
      const raisedEl  = $('#ppm-raised');
      const goalEl    = $('#ppm-goal');
      const pctEl     = $('#ppm-pct');

      const fmt$ = (n, cur='USD') => {
        try { return new Intl.NumberFormat(undefined,{style:'currency',currency:cur,maximumFractionDigits:0}).format(Math.round(+n||0)); }
        catch { return '$' + (Math.round(+n||0)).toLocaleString(); }
      };

      function parseDateTime(date, time){
        if (!date) return new Date(NaN);
        const t = (time||'').trim();
        let norm = t;
        if (t && !/^\d{1,2}:\d{2}\s*[ap]m$/i.test(t) && /^[0-9]{1,2}\s*[ap]m$/i.test(t)) norm = t.replace(/^(\d{1,2})\s*([ap]m)$/i,'$1:00 $2');
        const d1 = new Date(`${date} ${norm||'12:00 PM'}`); if (!isNaN(d1)) return d1;
        return new Date(date);
      }

      function toICS(evt){
        const start = parseDateTime(evt.date, evt.time);
        const end   = new Date(start.getTime() + 90*60*1000);
        const fmt = d => d.toISOString().replace(/[-:]/g,'').replace('.000','');
        const esc = s => String(s||'').replace(/([,;])/g,'\\$1').replace(/\n/g,'\\n');
        return [
          'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//FundChamps//ProgramPulseMini//EN',
          'BEGIN:VEVENT',
          'UID=' + (Date.now()+'@fundchamps'),
          'DTSTAMP=' + fmt(new Date()),
          'DTSTART=' + fmt(start),
          'DTEND=' + fmt(end),
          'SUMMARY=' + esc(evt.name || evt.opponent || 'Connect ATX Elite Event'),
          evt.location ? 'LOCATION=' + esc(evt.location) : null,
          'END:VEVENT','END:VCALENDAR'
        ].filter(Boolean).join('\\r\\n');
      }

      function gcalURL(evt){
        const start = parseDateTime(evt.date, evt.time);
        const end   = new Date(start.getTime() + 90*60*1000);
        const fmt = d => d.toISOString().replace(/[-:]/g,'').replace('.000','');
        const qs = new URLSearchParams({
          action:'TEMPLATE',
          text: (evt.name || evt.opponent || 'Connect ATX Elite Event'),
          dates: `${fmt(start)}/${fmt(end)}`,
          details: 'Connect ATX Elite ‚Äî FundChamps program event',
          location: evt.location || '',
          trp: 'true'
        });
        return 'https://calendar.google.com/calendar/render?' + qs.toString();
      }

      // Compute upcoming + next
      const now = new Date();
      const upcoming = (data.events||[])
        .map(e => ({...e, _start: parseDateTime(e.date, e.time)}))
        .filter(e => !isNaN(e._start) && e._start>= now)
        .sort((a,b) => a._start - b._start);

      listCount.textContent = String(upcoming.length);
      allLink.setAttribute('aria-label', `See all ${upcoming.length} events for Connect ATX Elite`);

      // Optional auto-hide
      if (!upcoming.length && hideIfEmpty && !isDemo) {
        ROOT.classList.add('ppm--hidden');
        ROOT.setAttribute('aria-hidden','true');
        return;
      } else {
        ROOT.classList.remove('ppm--hidden');
        ROOT.removeAttribute('aria-hidden');
      }

      if (upcoming.length === 0){
        heading.textContent = 'No upcoming events';
        sub.textContent = 'Check back soon!';
        countdown.textContent = '‚è≥ ‚Äî';
        icsBtn.setAttribute('aria-disabled','true');
        gcalLink.setAttribute('aria-disabled','true');
      } else {
        const next = upcoming[0];
        const friendlyWhen = next._start.toLocaleString(undefined, { dateStyle:'medium', timeStyle:'short' });
        heading.textContent = next.name || next.opponent || 'Connect ATX Elite Event';
        sub.textContent = `${friendlyWhen} ‚Ä¢ ${next.location || 'TBD'}${next.type ? ' ‚Ä¢ ' + next.type : ''}`;

        const updateCD = () => {
          const ms = next._start - new Date();
          if (ms <= 0){ countdown.textContent = '‚è≥ Now'; return; }
          const d = Math.floor(ms/86400000);
          const h = Math.floor((ms%86400000)/3600000);
          const m = Math.floor((ms%3600000)/60000);
          countdown.textContent = `‚è≥ ${d}d ${h}h ${m}m`;
        };
        updateCD(); if (!saveData) setInterval(updateCD, 60000);

        icsBtn.addEventListener('click', () => {
          const blob = new Blob([toICS(next)], { type:'text/calendar;charset=utf-8' });
          const a = Object.assign(document.createElement('a'), { href: URL.createObjectURL(blob), download: 'connect-atx-elite-next-event.ics' });
          document.body.appendChild(a); a.click(); a.remove();
        });
        gcalLink.href = gcalURL(next);
      }

      // Render top 3 upcoming
      listWrap.innerHTML = '';
      upcoming.slice(0,3).forEach(evt => {
        const row = document.createElement('div'); row.className = 'item'; row.role = 'listitem';
        const when = document.createElement('div'); when.className='when';
        when.textContent = evt._start.toLocaleString(undefined,{ month:'short', day:'2-digit'}) + ' ' +
                           evt._start.toLocaleTimeString(undefined,{ hour:'numeric', minute:'2-digit' });
        const what = document.createElement('div'); what.className='what';
        what.textContent = evt.name || evt.opponent || 'Connect ATX Elite Event';
        const where = document.createElement('div'); where.className='where';
        where.textContent = evt.location || '';
        row.append(when, what, where);
        listWrap.appendChild(row);
      });

      sr.textContent = 'Program Pulse ready. Press Enter on ‚ÄúUpcoming‚Äù to expand.';

      // Meter API
      function setMeter(raised, goal, cur='USD'){
        const R = Math.max(0, +raised||0), G = Math.max(0, +goal||0);
        const P = G ? Math.max(0, Math.min(100, (R/G)*100)) : 0;
        raisedEl.textContent = fmt$(R, cur);
        goalEl.textContent   = fmt$(G, cur);
        pctEl.textContent    = Math.round(P) + '%';
        fill.style.width     = P.toFixed(1) + '%';
      }
      addEventListener('fc:meter:update', ev => {
        const d = ev.detail||{}; setMeter(d.raised, d.goal, d.currency || 'USD');
      }, { passive:true });

      // Example priming (uncomment if you pass Jinja vars):
      // window.dispatchEvent(new CustomEvent('fc:meter:update', {
      //   detail: { raised: {{ (funds_raised or 0)|round(0) }}, goal: {{ (fundraising_goal or 0)|round(0) }}, currency:'USD' }
      // }));
    })();
  </script>
</section>
{% endif %}

