
{# FF: Logo fallback helper #}
{% set _org_logo = _org_logo|default(url_for('static', filename='images/fundchamps-fc.svg')) %}


<!--
üíé FUTUREFUNDED GO-LIVE CHECKLIST (UI/UX)

1. LOGO wired from Flask context (_org_logo)
2. Accessibility: skiplinks, focus rings, ARIA
3. Responsive test on mobile/tablet/desktop
4. Powered by FutureFunded badge present
5. PWA icons + manifest verified
6. No overflow / no bleed / theme verified
-->

<!-- fc-sponsors Enterprise-grade Drop‚Äëin (v2.0) ‚Äî Production Ready -->
{% from 'partials/_core_helpers.html' import nonce_attr %}
{% set SHOW       = SHOW_TICKER | default(true) %}
{% set DEMO       = SHOW_DEMO   | default(false) %}
{% if SHOW %}
{% set seed        = shoutouts | default([]) %}
{% set teamKey     = team.team_id     | default('global') %}
{% set accent      = team.theme_color | default('#facc15') %}
{% set api_shout   = (safe_url_for('api.shoutouts') if safe_url_for is defined and has_endpoint('api.shoutouts') else '/api/shoutouts') %}
{% set DONATE_HREF = HREF_DONATE | default(stripe_payment_link | default('/donate')) %}

<section id="fcx-sponsors"
         class="sx sx--pro print:hidden"
         role="region"
         aria-label="Live sponsor shout‚Äëouts"
         style="--accent: {{ accent }};"
         data-team="{{ teamKey }}"
         data-api="{{ api_shout }}"
         data-donate="{{ DONATE_HREF }}"
         data-demo="{{ '1' if DEMO else '0' }}"
         data-compact="{{ '1' if COMPACT else '0' }}"
         data-demo-seed='{{ [
           {"who":"Nike","msg":"Just do it!","tier":"Platinum","url":"https://www.nike.com","logo":"/static/img/nike.png"},
           {"who":"Apple","msg":"Gifting 10 iPads for film study","tier":"Gold","url":"https://apple.com","logo":"https://logo.clearbit.com/apple.com"},
           {"who":"Shopify","msg":"Proud to back local champs","tier":"Gold","logo":"https://logo.clearbit.com/shopify.com"},
           {"who":"Stripe","msg":"Covering processing fees this month","tier":"Silver","url":"https://stripe.com","logo":"https://logo.clearbit.com/stripe.com"},
           {"who":"Patagonia","msg":"Keeping the team warm on away days","tier":"Bronze"},
           {"who":"Gatorade","msg":"Fuel for every practice","tier":"Silver","logo":"https://logo.clearbit.com/gatorade.com"}
         ] | tojson }}'>

  <!-- Live regions -->
  <p class="sr-only" id="sr-shout" aria-live="polite">Live shout‚Äëouts active.</p>
  <p class="sr-only" id="sr-vip" aria-live="assertive" aria-atomic="true"></p>

  <!-- Skip link for a11y -->
  <a class="u-skip" href="#main" tabindex="0">Skip sponsor ticker</a>

  <div class="sx-vp" role="presentation">
    <div class="edge edge--l" aria-hidden="true"></div>
    <div class="edge edge--r" aria-hidden="true"></div>

    <div class="track" id="track" role="list" aria-busy="true" aria-live="off" aria-label="Sponsor ticker">
      <!-- Dynamic pills will render here ‚Üí see JS -->
      <span class="pill empty" id="pill-empty"><span>No shout‚Äëouts yet ‚Äî </span><button class="link" id="cta-donate" type="button" data-cta="ticker-donate">be the first üéâ</button></span>
      <span class="pill offline" id="pill-offline" hidden>‚ö† Offline ‚Äî retrying‚Ä¶</span>

      <span class="brand" aria-hidden="true">
        <svg viewBox="0 0 24 24" width="14" height="14" aria-hidden="true"><path d="M12 2l7 4v6c0 5-3.5 8-7 10-3.5-2-7-5-7-10V6l7-4z" fill="currentColor"/></svg>
        Powered by FundChamps
      </span>
      <button class="ctrl pause" id="btn-pause" aria-pressed="false" aria-controls="track" aria-label="Pause ticker" title="Pause">‚è∏</button>
      <button class="ctrl speed" id="btn-speed" aria-controls="track" aria-label="Speed: Normal" data-speed="normal" title="Speed">‚è©</button>
      <button class="ctrl theme-toggle" id="btn-theme" aria-label="Toggle dark / light theme" title="Theme">üåó</button>
    </div>
  </div>

  <!-- Details modal (a11y‚Äëfirst) -->
  <dialog id="shout-dialog" class="shout-dialog" aria-modal="true" aria-labelledby="dlg-title" aria-describedby="dlg-msg">
    <form method="dialog">
      <h3 id="dlg-title"></h3>
      <p id="dlg-msg"></p>
      <a id="dlg-link" class="dlg-link" href="#" target="_blank" rel="noopener noreferrer" hidden>Visit sponsor ‚Üí</a>
      <button class="btn lite dlg-close" value="close">Close</button>
    </form>
  </dialog>
</section>

<style {{ nonce_attr() }}>
/***** Tokens *****/
#fcx-sponsors{ --h:48px; --pad:.5rem; --gap:.5rem; --fs:.9rem; --rad:999px; --rail-speed:28s; --bg:color-mix(in srgb,#0b0c12 85%,transparent); --chip:#12161c; --chip-2:#181d26; --txt:#f1f5f9; --muted:#9aa3bb; --ring:#ffffff14; --shadow:0 2px 12px rgba(0,0,0,.25);} 
html.dark #fcx-sponsors{ --txt:#111827; --muted:#6b7280; --ring:#00000033; }

/***** Skip link *****/
.u-skip{ position:absolute; left:-999px; top:-999px; padding:.5rem 1rem; background:#fff; color:#000; border-radius:.5rem; font-weight:700; }
.u-skip:focus-visible{ left:1rem; top:1rem; z-index:1100; }

/***** Viewport *****/
.sx-vp{ position:relative; display:flex; align-items:center; height:var(--h); padding-inline:var(--pad); background:var(--bg); border:1px solid var(--ring); border-radius:1rem; overflow:hidden; backdrop-filter:blur(10px); box-shadow:var(--shadow);} 
.edge{ position:absolute; inset-block:0; inline-size:40px; pointer-events:none; z-index:2; }
.edge--l{ inset-inline-start:0; background:linear-gradient(90deg,#0b0e15,transparent); }
.edge--r{ inset-inline-end:0; background:linear-gradient(270deg,#0b0e15,transparent); }

/***** Track *****/
.track{ display:flex; align-items:center; gap:var(--gap); min-width:100%; white-space:nowrap; will-change:transform; animation:sx-scroll var(--rail-speed) linear infinite; }
@keyframes sx-scroll{ from{transform:translateX(100%);} to{transform:translateX(-100%);} }
.sx[data-paused="true"] .track{ animation-play-state:paused; }

/***** Pills *****/
.pill{ display:inline-flex; align-items:center; gap:.5rem; line-height:1; font-size:var(--fs); background:var(--chip); color:var(--txt); border:1px solid var(--ring); border-radius:var(--rad); font-weight:800; padding:.35rem .8rem; box-shadow:inset 0 0 0 1px rgba(255,255,255,.04); text-decoration:none; }
.pill img{ inline-size:18px; block-size:18px; border-radius:4px; background:#fff; object-fit:contain; }
.pill[data-tier="Platinum"]{ background:linear-gradient(135deg,#1b1f29,#141821); border-color:#7dd3fc44; box-shadow:0 0 10px rgba(125,211,252,.25);} 
.pill[data-tier="Gold"]{ background:linear-gradient(135deg,#1d1a12,#151109); border-color:color-mix(in srgb,var(--accent)45%,transparent); box-shadow:0 0 8px color-mix(in srgb,var(--accent)25%,transparent);} 
.pill[data-tier="Silver"]{ background:linear-gradient(135deg,#191f26,#14181e); border-color:#9ca3af33;} 
.pill[data-tier="Bronze"]{ background:linear-gradient(135deg,#21190f,#191107); border-color:#f59e0b22;} 
.pill.empty{ background:var(--chip-2); color:var(--muted);} .pill.offline{ background:#221823; color:#ffb4b4;} 
.brand{ display:inline-flex; align-items:center; gap:.35rem; font-size:.78rem; color:color-mix(in srgb,var(--accent)70%,white15%); margin-left:.4rem;} 

.ctrl{ background:var(--chip-2); color:var(--txt); border:1px solid var(--ring); border-radius:var(--rad); padding:.18rem .5rem; font-size:.78rem; font-weight:900; cursor:pointer; }
.ctrl:hover{ background:color-mix(in srgb,var(--accent)25%,#1a1f28); color:var(--accent);} 
.link{ background:none; border:none; color:var(--accent); font-weight:900; text-decoration:underline; cursor:pointer; }

/***** Dialog *****/
.shout-dialog{ padding:1.2rem 1rem; border:none; border-radius:1rem; background:#0f1117; color:var(--txt); max-inline-size:25rem; box-shadow:0 20px 70px rgba(0,0,0,.6);} 
.dlg-link{ display:inline-block; margin:.6rem 0; color:var(--accent); font-weight:900;} 
.dlg-close{ margin-top:1rem;} 

/***** Theme toggle visuals *****/
.theme-toggle::after{ content:""; width:1rem; height:1rem; border-radius:50%; background:currentColor; display:inline-block; box-shadow:inset 0 0 0 2px currentColor; }
html.dark .theme-toggle::after{ box-shadow:none; background:currentColor; }

/***** Compact variant *****/
[data-compact="1"]{ --h:40px; --fs:.85rem; --rail-speed:32s; }

/***** Prefers *****/
@media(prefers-reduced-motion:reduce){ .track{ animation:none; } .edge{ display:none; } }
@media(forced-colors:active){ .sx-vp{ background:Canvas; border-color:CanvasText;} .pill,.ctrl,.brand{ forced-color-adjust:auto; border:1px solid ButtonText;} }

@media print{ #fcx-sponsors{ display:none !important;} }
#fcx-sponsors {
  margin: 0;
  /* The sticky header is already offset via position:sticky,
     so no margin-top needed here! */
}

@media (min-width: 600px) {
  #fcx-sponsors {
    /* If you want a slightly bigger bar on desktop */
    --sponsor-leaderboard-h: 60px;
  }
}
</style>

<script {{ nonce_attr() }} type="module">
(()=>{
  const ROOT=document.getElementById('fcx-sponsors'); if(!ROOT||ROOT.__wired)return; ROOT.__wired=true;
  const track=ROOT.querySelector('#track');
  const pauseBtn=ROOT.querySelector('#btn-pause');
  const speedBtn=ROOT.querySelector('#btn-speed');
  const themeBtn=ROOT.querySelector('#btn-theme');
  const offlinePill=ROOT.querySelector('#pill-offline');
  const emptyPill=ROOT.querySelector('#pill-empty');
  const srVip=document.getElementById('sr-vip');
  const dialog=document.getElementById('shout-dialog');
  const dlgTitle=document.getElementById('dlg-title');
  const dlgMsg=document.getElementById('dlg-msg');
  const dlgLink=document.getElementById('dlg-link');

  const TEAM=ROOT.dataset.team||'global';
  const API=ROOT.dataset.api||'/api/shoutouts';
  const DEMO=ROOT.dataset.demo==='1';
  const DONATE=ROOT.dataset.donate||'/donate';
  const DEMO_SEED=(()=>{try{return JSON.parse(ROOT.dataset.demoSeed||'[]');}catch{return[];}})();

  /* ‚Äî‚Äî Theme toggle ‚Äî‚Äî */
  const rootEl=document.documentElement;
  const applyTheme=m=>{ rootEl.classList.toggle('dark',m==='dark'); rootEl.classList.toggle('light',m==='light'); localStorage.setItem('theme',m); themeBtn?.setAttribute('aria-label',`Switch to ${m==='dark'?'light':'dark'} theme`);} ;
  (function initTheme(){ const saved=localStorage.getItem('theme'); if(saved){applyTheme(saved);} else{applyTheme(matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light');}})();
  themeBtn?.addEventListener('click',()=>applyTheme(rootEl.classList.contains('dark')?'light':'dark'),{passive:true});

  /* ‚Äî‚Äî Pause & speed ‚Äî‚Äî */
  const speeds={slow:'38s',normal:'28s',fast:'18s'}; const SPEED_KEY=`fcx:speed:${TEAM}`;
  function setSpeed(m='normal'){ track.style.animationDuration=speeds[m]||speeds.normal; speedBtn.dataset.speed=m; speedBtn.setAttribute('aria-label',`Speed: ${m}`); speedBtn.textContent=(m==='fast')?'‚è™':'‚è©'; localStorage.setItem(SPEED_KEY,m);} setSpeed(localStorage.getItem(SPEED_KEY)||'normal');
  const setPaused=p=>{ROOT.dataset.paused=p?'true':'false'; pauseBtn.setAttribute('aria-pressed',String(p)); pauseBtn.textContent=p?'‚ñ∂':'‚è∏'; pauseBtn.setAttribute('aria-label',p?'Resume ticker':'Pause ticker');}; setPaused(false);
  pauseBtn.addEventListener('click',()=>setPaused(ROOT.dataset.paused!=='true')); speedBtn.addEventListener('click',()=>{const cur=speedBtn.dataset.speed||'normal'; setSpeed(cur==='slow'?'normal':cur==='normal'?'fast':'slow');});
  ROOT.addEventListener('mouseenter',()=>setPaused(true)); ROOT.addEventListener('mouseleave',()=>setPaused(false));

  /* ‚Äî‚Äî Local storage dedupe (TTL 7d) ‚Äî‚Äî */
  const LS=`fcx:shouts:${TEAM}`,TTL=7*24*60*60*1000,now=()=>Date.now();
  const read=()=>{try{return(JSON.parse(localStorage.getItem(LS)||'[]')).filter(x=>now()-(x.ts||0)<TTL);}catch{return[];}};
  const write=a=>{try{localStorage.setItem(LS,JSON.stringify(a.slice(-160)));}catch{}};
  const sig=o=>[o.who,o.msg,o.tier,o.url].map(x=>String(x||'').toLowerCase()).join('|');
  const recent=new Set(read().map(sig));

  const emoji=t=>({Platinum:'‚ú®',Gold:'üèÖ',Silver:'üéâ',Bronze:'ü•â'}[t]||'üéâ');
  const nameOf=w=>w?String(w):'Sponsor';
  function pillNode(o){
    const wrap=o.url?document.createElement('a'):document.createElement('span');
    wrap.className='pill'; wrap.setAttribute('role','listitem');
    if(o.tier) wrap.dataset.tier=o.tier; if(o.url){wrap.href=o.url; wrap.target='_blank'; wrap.rel='noopener noreferrer';}
    const ico=document.createElement('span'); ico.textContent=`${emoji(o.tier)} `;
    wrap.appendChild(ico);
    if(o.logo){ const img=document.createElement('img'); img.src=o.logo; img.alt=o.who; wrap.appendChild(img);} 
    wrap.appendChild(document.createTextNode(`${nameOf(o.who)} ‚Äî ${o.msg||''}`));
    wrap.addEventListener('click',e=>{ if(e.metaKey||e.ctrlKey||o.url) return; showDialog(o);} );
    return wrap; }

  function add(o,{front=false}={}){ const key=sig(o); if(recent.has(key)) return; recent.add(key); const node=pillNode(o); if(front) track.insertBefore(node, track.firstChild); else track.appendChild(node); emptyPill?.remove(); ROOT.classList.remove('is-empty'); if(/platinum|gold/i.test(o.tier||'')&&srVip){srVip.textContent=`${nameOf(o.who)} joined as ${o.tier}!`; setTimeout(()=>srVip.textContent='',2500);} }
  function pushStore(o){ const s=read(); s.push({...o,ts:now()}); write(s); }

  /* ‚Äî‚Äî Dialog for details ‚Äî‚Äî */
  function showDialog(o){ dlgTitle.textContent=nameOf(o.who); dlgMsg.textContent=o.msg||''; if(o.url){dlgLink.href=o.url; dlgLink.hidden=false; } else dlgLink.hidden=true; dialog.showModal(); }

  /* ‚Äî‚Äî Initial seeds ‚Äî‚Äî */
  read().forEach(add); if(DEMO) DEMO_SEED.forEach(add);
  function ensureLoop(){ const vpW=ROOT.querySelector('.sx-vp').offsetWidth; let totalW=0; [...track.children].forEach(c=>totalW+=c.offsetWidth+8); if(totalW<vpW*1.6){ const clone=track.cloneNode(true); clone.id=''; clone.querySelectorAll('#pill-empty,#pill-offline,.brand,.ctrl').forEach(n=>n.remove()); track.append(...clone.querySelectorAll('.pill')); } }
  setTimeout(ensureLoop,100);

  /* ‚Äî‚Äî Networking: poll + SSE ‚Äî‚Äî */
  let backoff=4000,maxBack=32000,lastTs=0; async function poll(){ if(document.hidden){setTimeout(poll,backoff); return;} try{ const url=new URL(API,location.origin); url.searchParams.set('team',TEAM); if(lastTs) url.searchParams.set('since',String(lastTs)); const res=await fetch(url.toString(),{cache:'no-store',headers:{'Accept':'application/json'}}); if(!res.ok) throw 0; const j=await res.json(); j.forEach(d=>{ const it={ who:d.brand||d.name||d.who,msg:d.msg||d.message,tier:d.tier||d.level,url:d.url||d.link,logo:d.logo,ts:d.ts||now() }; add(it,{front:true}); pushStore(it); lastTs=Math.max(lastTs,it.ts); }); offlinePill.hidden=true; backoff=4000; ensureLoop(); } catch { offlinePill.hidden=false; backoff=Math.min(backoff*1.6,maxBack);} finally{ setTimeout(poll,backoff);} } poll();
  if('EventSource'in window){ try{ const es=new EventSource(`${API.replace('/api/','/sse/')}?team=${encodeURIComponent(TEAM)}`); es.onmessage=e=>{ try{ const d=JSON.parse(e.data); const it={ who:d.brand||d.name||d.who,msg:d.msg||d.message,tier:d.tier,url:d.url,logo:d.logo,ts:d.ts||now() }; add(it,{front:true}); pushStore(it); lastTs=Math.max(lastTs,it.ts); ensureLoop(); }catch{}}; es.onerror=()=>{try{es.close();}catch{}}; addEventListener('pagehide',()=>{try{es.close();}catch{}},{once:true}); }catch{} }

  /* ‚Äî‚Äî IntersectionObserver pauses ‚Äî‚Äî */
  if('IntersectionObserver'in window){ const io=new IntersectionObserver(([e])=>setPaused(!e.isIntersecting),{threshold:0.01}); io.observe(ROOT);} 
  const updateOnline=()=>offlinePill.hidden=navigator.onLine; addEventListener('online',()=>{updateOnline(); poll();}); addEventListener('offline',updateOnline); updateOnline();

  /* ‚Äî‚Äî CTA donate ‚Äî‚Äî */
  document.getElementById('cta-donate')?.addEventListener('click',()=>{ if(DONATE.startsWith('http')) window.open(DONATE,'_blank','noopener'); else location.assign(DONATE); });

  /* ‚Äî‚Äî Reduced motion fallback ‚Äî‚Äî */
  if(matchMedia('(prefers-reduced-motion: reduce)').matches){ ROOT.classList.add('no-animate'); track.style.animation='none'; track.style.gap='.75rem'; track.setAttribute('tabindex','0'); track.setAttribute('aria-live','polite'); }

  ROOT.style.opacity='0'; ROOT.style.transition='opacity .8s ease'; requestAnimationFrame(()=>ROOT.style.opacity='1');
})();
</script>
{% endif %}

