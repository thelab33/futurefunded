
{# FF: Logo fallback helper #}
{% set _org_logo = _org_logo|default(url_for('static', filename='images/fundchamps-fc.svg')) %}


<!--
ðŸ’Ž FUTUREFUNDED GO-LIVE CHECKLIST (UI/UX)

1. LOGO wired from Flask context (_org_logo)
2. Accessibility: skiplinks, focus rings, ARIA
3. Responsive test on mobile/tablet/desktop
4. Powered by FutureFunded badge present
5. PWA icons + manifest verified
6. No overflow / no bleed / theme verified
-->

{# ===================== FCX NEWSLETTER â€” Enterprise Modal (v2, CSP-safe) ===================== #}
{# Single-file partial: markup + scoped styles + behavior. Flask/Jinja compatible, CSP nonce-ready. #}

{% set NONCE = NONCE if NONCE is defined else (csp_nonce() if csp_nonce is defined else '') %}
{% macro nonce_attr() -%}{% if NONCE %}nonce="{{ NONCE }}"{% endif %}{%- endmacro %}

{# -------- Sensible defaults (overridable via context) -------- #}
{% set TEAM_NAME = (team.team_name if team is defined and team.team_name else TEAM_NAME if TEAM_NAME is defined else 'Connect ATX Elite') %}
{% set ACCENT    = (team.theme_color if team is defined and team.theme_color else ACCENT if ACCENT is defined else '#facc15') %}
{% set SIGNUP_URL = SIGNUP_URL if SIGNUP_URL is defined else (safe_url_for('newsletter.signup') if (safe_url_for is defined and has_endpoint is defined and has_endpoint('newsletter.signup')) else '/newsletter/signup') %}

<dialog id="nlx-modal"
        class="nlx-modal"
        aria-modal="true"
        aria-labelledby="nlx-title"
        aria-describedby="nlx-desc"
        data-autoshow="0">
  <form id="nlx-form" method="dialog" class="nlx-box" role="form" aria-live="polite" aria-atomic="true">
    <button type="button" class="nlx-close" aria-label="Close signup" data-close>&times;</button>

    <div class="nlx-logo" aria-hidden="true">
      <!-- Less flashy, neutral icon -->
      <svg width="46" height="46" viewBox="0 0 48 48" fill="none" aria-hidden="true">
        <circle cx="24" cy="24" r="22" fill="#23252e" stroke="#e9c46a" stroke-width="2"/>
        <path d="M16 24h16" stroke="#b2b8c3" stroke-width="2" stroke-linecap="round"/>
        <path d="M24 16v16" stroke="#b2b8c3" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </div>

    <h2 id="nlx-title" class="nlx-title">Join <span class="nlx-accent">{{ TEAM_NAME }}</span> Updates</h2>
    <p id="nlx-desc" class="nlx-sub">A monthly highlight: stories, invites, ways to help. Zero spam.</p>

    <label class="nlx-field">
      <span class="sr-only">Email address</span>
      <input id="nlx-email" name="email" type="email" inputmode="email" autocomplete="email"
             placeholder="you@example.com" required aria-required="true" aria-describedby="nlx-err"/>
    </label>

    <label class="nlx-field">
      <span class="sr-only">Invite a friend (optional)</span>
      <input id="nlx-invite" name="invite" type="email" inputmode="email" autocomplete="email"
             placeholder="Friendâ€™s email (optional)"/>
    </label>

    <p id="nlx-err" class="nlx-err" role="alert" aria-live="assertive"></p>

    <div class="nlx-actions">
      <button id="nlx-submit" type="submit" class="nlx-btn nlx-primary">
        <span>Subscribe</span>
      </button>
      <button id="nlx-later" type="button" class="nlx-btn nlx-ghost" data-close>Maybe later</button>
    </div>

    <p id="nlx-thanks" class="nlx-thanks" hidden aria-live="polite">
      Youâ€™re in! Thank you for backing our kids.
    </p>
  </form>
</dialog>

<style {{ nonce_attr() }}>
  .nlx-modal { position: fixed; inset: 0; margin: auto; padding: 0; border: 0; background: transparent; display: none; }
  .nlx-modal[open] { display: grid; place-items: center; }
  .nlx-modal::backdrop { background: rgba(22,23,28,.85); backdrop-filter: blur(2px); }
  .nlx-box {
    --accent: #e9c46a;
    width: min(92vw, 400px);
    border-radius: 18px;
    background: #191b22;
    color: #f3f4f7;
    border: 1px solid #23252e;
    box-shadow: 0 12px 42px #000b, 0 2px 0 var(--accent);
    padding: 22px 20px 18px 20px;
    font-family: Inter, system-ui, sans-serif;
    opacity: 0;
    transform: translateY(6px) scale(.98);
  }
  .nlx-box.nlx-in { transform: none; opacity: 1; transition: transform .23s, opacity .23s }
  .nlx-box.nlx-out { transform: translateY(6px) scale(.98); opacity: 0; transition: transform .17s, opacity .17s }
  .nlx-close {
    position: absolute; right: 12px; top: 12px; width: 36px; height: 36px;
    display: grid; place-items: center; border-radius: 999px; border: none;
    background: #23252e; color: #b2b8c3; font-size: 22px; line-height: 1; cursor: pointer;
  }
  .nlx-title { margin: 10px 0 3px; font-weight: 900; font-size: 1.33rem; line-height: 1.12; text-align: center; }
  .nlx-accent { color: var(--accent); }
  .nlx-sub { margin: 0 0 13px; text-align: center; color: #b2b8c3; font-weight: 600; }
  .nlx-logo { display: grid; place-items: center; margin-bottom: 3px; }
  .nlx-field { display: block; margin: 7px 0; }
  .nlx-field input {
    width: 100%; border-radius: 999px; border: 1px solid #23252e;
    background: #23252e; color: #f3f4f7;
    padding: .75rem 1.1rem; font-weight: 600;
    font-size: 1rem; margin-bottom: 0;
  }
  .nlx-field input:focus { outline: none; border-color: var(--accent); }
  .nlx-err { min-height: 1.25rem; margin: 4px 4px 0; color: #ffc7b4; font-weight: 700; }
  .nlx-actions { display: flex; gap: 10px; justify-content: center; margin-top: 11px; flex-wrap: wrap }
  .nlx-btn {
    border-radius: 999px; padding: .7rem 1.1rem; font-weight: 900;
    font-size: 1rem; border: 2px solid #e9c46a40; background: #f3f4f7; color: #191b22; transition: all .17s;
    box-shadow: 0 1px 8px #0001;
  }
  .nlx-btn:hover, .nlx-btn:focus-visible { border-color: #e9c46a; background: #e9c46a; color: #1a1d24; }
  .nlx-ghost { background: transparent; color: #b2b8c3; border: 1.5px solid #23252e; }
  .nlx-thanks { text-align: center; margin: 12px 0 4px; font-weight: 900; color: #60b4fa; }
  @media (max-width:500px) { .nlx-box { padding: 13px 6px 9px 6px; width: 97vw; } }
</style>

{# =========================== Behavior (CSP-safe) =========================== #}
<script {{ nonce_attr() }}>
(function(){
  'use strict';
  const modal = document.getElementById('nlx-modal');
  if (!modal || window.__NLX__) return; window.__NLX__ = true;

  const form   = document.getElementById('nlx-form');
  const email  = document.getElementById('nlx-email');
  const invite = document.getElementById('nlx-invite');
  const err    = document.getElementById('nlx-err');
  const thanks = document.getElementById('nlx-thanks');
  const swish  = document.querySelector('.nlx-swish');
  const submit = document.getElementById('nlx-submit');

  const SIGNUP_URL = '{{ SIGNUP_URL|e }}';
  const rm = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  function openModal(){
    try {
      if (typeof modal.showModal === 'function') modal.showModal(); else modal.setAttribute('open','');
      requestAnimationFrame(()=> document.querySelector('.nlx-box')?.classList.add('nlx-in'));
      // Focus trap
      setTimeout(()=> email?.focus({preventScroll:true}), 60);
    } catch(_) {}
  }
  function closeModal(){
    const box = document.querySelector('.nlx-box');
    box?.classList.remove('nlx-in'); box?.classList.add('nlx-out');
    setTimeout(()=> {
      if (typeof modal.close === 'function') modal.close(); else modal.removeAttribute('open');
      box?.classList.remove('nlx-out');
    }, rm ? 0 : 180);
  }

  // Close click handlers
  modal.addEventListener('click', (e)=> {
    if (e.target && e.target.hasAttribute('data-close')) closeModal();
    if (e.target === modal) closeModal(); // backdrop click
  });
  document.addEventListener('keydown', (e)=> { if (e.key === 'Escape' && modal.open) closeModal(); });

  // Submit
  form.addEventListener('submit', async (e)=> {
    e.preventDefault();
    err.textContent='';
    const val = (email.value || '').trim();
    if (!/^[^@\\s]+@[^@\\s]+\\.[^@\\s]+$/.test(val)) { err.textContent = 'Please enter a valid email.'; email.focus(); return; }
    submit.disabled = true;

    // Visual swish
    if (swish && !rm){ swish.style.opacity='1'; swish.style.transform='translateY(0)'; setTimeout(()=>{ swish.style.opacity='0'; swish.style.transform='translateY(-6px)'; }, 700); }

    // CSRF token (if provided in meta)
    let headers = { 'Content-Type': 'application/json', 'Accept': 'application/json' };
    const meta = document.querySelector('meta[name="csrf-token"]'); if (meta) headers['X-CSRFToken'] = meta.getAttribute('content')||'';

    try {
      const res = await fetch(SIGNUP_URL, {
        method: 'POST',
        headers,
        body: JSON.stringify({ email: val, invite: (invite.value||'').trim() })
      });
      // Accept both JSON and 204
      if (res.ok){
        try{ await res.json(); }catch{}
        thanks.hidden = false;
        // store once-per-session flag
        sessionStorage.setItem('nlx_subscribed', '1');
        setTimeout(closeModal, 900);
      } else {
        err.textContent = 'Could not subscribe right now. Please try again.';
      }
    } catch(_){
      err.textContent = 'Network error. Please try again.';
    } finally {
      submit.disabled = false;
    }
  });

  // Public API
  window.fcxNewsletter = {
    open: openModal,
    close: closeModal,
    maybeAuto: function(){ 
      const autoshow = modal.getAttribute('data-autoshow') === '1';
      if (!autoshow) return;
      if (sessionStorage.getItem('nlx_subscribed') === '1') return;
      // Open after a short dwell time
      setTimeout(openModal, 1800);
    }
  };

  // Auto open via query (?subscribe=1) or data-autoshow
  try {
    const q = new URLSearchParams(location.search);
    if (q.get('subscribe') === '1') openModal(); else window.fcxNewsletter.maybeAuto();
  } catch(_) { window.fcxNewsletter.maybeAuto(); }

  // Optional: global triggers
  document.addEventListener('click', (e)=> {
    const t = e.target.closest('[data-open-newsletter]'); if (!t) return; e.preventDefault(); openModal();
  }, { passive:true });
})();
</script>
