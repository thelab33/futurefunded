
{# FF: Logo fallback helper #}
{% set _org_logo = _org_logo|default(url_for('static', filename='images/fundchamps-fc.svg')) %}


<!--
ðŸ’Ž FUTUREFUNDED GO-LIVE CHECKLIST (UI/UX)

1. LOGO wired from Flask context (_org_logo)
2. Accessibility: skiplinks, focus rings, ARIA
3. Responsive test on mobile/tablet/desktop
4. Powered by FutureFunded badge present
5. PWA icons + manifest verified
6. No overflow / no bleed / theme verified
-->

{# templates/partials/hero.html â€” v2 #}
{% macro nonce_attr() -%}{% if NONCE %}nonce="{{ NONCE }}"{% endif %}{%- endmacro %}
{% macro money(n) -%}{{ '$' ~ ('{:,}'.format((n|int) if n is not none else 0)) }}{%- endmacro %}

{# ===== Inputs (override from backend/config) ===== #}
{%- set TEAM        = TEAM_NAME           | default('Connect ATX Elite') -%}
{%- set GOAL        = PROGRESS_GOAL       | default(50000) | int -%}
{%- set RAISED      = PROGRESS_RAISED     | default(21000) | int -%}
{%- set PCT         = ((RAISED / (GOAL if GOAL>0 else 1)) * 100) | round(0) -%}
{%- set DONATE      = DONATE_URL          | default('/donate') -%}
{%- set ACC         = ACCENT              | default('#facc15') -%}
{%- set IMG         = HERO_IMG_SRC        | default('/static/images/connect-atx-team.jpg') -%}
{%- set AVIF        = HERO_IMG_AVIF -%}
{%- set WEBP        = HERO_IMG_WEBP -%}
{%- set ALT         = HERO_IMG_ALT        | default(TEAM ~ ' team') -%}
{%- set API         = PROGRESS_API        | default('/api/progress') -%}
{%- set QR          = QR_SRC              | default('/static/images/qr/connect-atx-qr.png') -%}
{%- set KPIS        = KPIS                | default([{'label':'Games','value':'35+'},{'label':'Championships','value':'5'},{'label':'Training hrs / wk','value':'120+'}]) -%}
{%- set AMTS        = QUICK_AMOUNTS       | default([25,50,100,250]) -%}
{%- set TRUST_LOGOS = TRUST_LOGOS         | default([{'src':'/static/trust/stripe.svg','alt':'Stripe'},{'src':'/static/trust/paypal.svg','alt':'PayPal'}]) -%}
{%- set END         = END                 | default(None) -%}  {# ISO 8601 e.g. 2025-12-31T23:59:00Z #}
{%- set TICKER      = TICKER_SRC          | default('') -%}    {# JSON: [{name, amount, ts}] newest first #}
{%- set CURRENCY    = CURRENCY            | default('USD') -%}
{%- set LOCALE      = LOCALE              | default('en-US') -%}

<section id="fc-hero"
  class="fc-hero band--hero band--wide hero--xl"
  aria-label="{{ TEAM }} fundraiser hero"
  data-donate="{{ DONATE }}"
  data-api="{{ API }}"
  data-goal="{{ GOAL }}"
  data-raised="{{ RAISED }}"
  data-end="{{ END or '' }}"
  data-ticker="{{ TICKER }}"
  data-currency="{{ CURRENCY }}"
  data-locale="{{ LOCALE }}"
  style="--accent: {{ ACC }}; --container-max: 1400px;">

  <div class="hero-frame" data-animate>
    <div class="hero-bg" aria-hidden="true"></div>
    <div class="hero-inner">
      <!-- VISUAL -->
      <figure class="hero-media" aria-label="{{ ALT }}">
        <picture>
          {% if AVIF %}<source srcset="{{ AVIF }}" type="image/avif" fetchpriority="high">{% endif %}
          {% if WEBP %}<source srcset="{{ WEBP }}" type="image/webp" fetchpriority="high">{% endif %}
          <img class="hero-img"
               src="{{ IMG }}"
               alt="{{ ALT }}"
               width="1600" height="1000"
               loading="eager" decoding="async" fetchpriority="high"
               srcset="
                 {{ IMG_640  or IMG }} 640w,
                 {{ IMG_960  or IMG }} 960w,
                 {{ IMG_1280 or IMG }} 1280w,
                 {{ IMG_1600 or IMG }} 1600w,
                 {{ IMG_2000 or IMG }} 2000w"
               sizes="(max-width: 1100px) 100vw, min(64vw, 1120px)"
               style="view-transition-name: hero; object-position:center var(--hero-focal-y, 15%);">
        </picture>

        <!-- PROGRESS RAIL -->
        <div class="hero-rail" aria-describedby="hero-rail-meta">
          <div class="hero-rail__bar" role="progressbar"
               aria-label="{{ money(RAISED) }} of {{ money(GOAL) }} raised"
               aria-valuemin="0" aria-valuemax="{{ GOAL }}" aria-valuenow="{{ RAISED }}"
               style="--pct: {{ PCT }};">
            <span class="hero-rail__fg" aria-hidden="true"></span>
          </div>
          <div id="hero-rail-meta" class="hero-rail__meta">
            <span>
              <strong class="js-raised" data-count data-currency="{{ CURRENCY }}" data-locale="{{ LOCALE }}" data-to="{{ RAISED }}">{{ money(RAISED) }}</strong>
              <small>/ <span class="js-goal" data-count data-currency="{{ CURRENCY }}" data-locale="{{ LOCALE }}" data-to="{{ GOAL }}">{{ money(GOAL) }}</span></small>
            </span>
            <span class="hero-rail__pct js-pct" data-count data-suffix="%" data-to="{{ PCT }}">{{ PCT }}%</span>
          </div>
        </div>

        <!-- DONOR TICKER -->
        <div class="ticker-wrap" aria-hidden="true">
          <ul class="donor-ticker" aria-label="Recent supporters" aria-live="polite">
            <li class="ghost">âš¡ Be the first donor â€” every dollar counts!</li>
          </ul>
        </div>
      </figure>

      <!-- COPY -->
      <div class="hero-copy" aria-describedby="hero-sub hero-kpis countdown">
        <span class="badge hero-badge" data-animate style="--d:.0s">
          <svg class="badge-dot" viewBox="0 0 8 8" aria-hidden="true"><circle cx="4" cy="4" r="4"/></svg>
          {{ TEAM }}
        </span>

        <h1 class="headline hero-headline" data-animate style="--d:.02s">
          Fuel the <span class="hl-accent">Season.</span><br>
          Fund the <span class="hl-accent">Future.</span>
        </h1>

        <p class="hero-tag" data-animate style="--d:.06s">Back youth. Build the future.</p>
        <p id="hero-sub" class="sub hero-sub" data-animate style="--d:.12s">
          Direct support for gear, travel, and tutoringâ€”every dollar moves a kid forward.
          <span class="hl-fade">Tap to give, share to amplify.</span>
        </p>

        <p id="countdown" class="countdown" role="status" aria-live="polite" data-animate style="--d:.14s"></p>

        <!-- KPI COUNT-UP -->
        <ul id="hero-kpis" class="kpi-list" aria-label="Team highlights">
          {% for k in KPIS %}
            <li data-animate style="--d: {{ (loop.index0 * 0.08) | round(2) }}s">
              <strong data-count data-to="{{ k.value|replace('+','')|replace(',','') }}">{{ k.value }}</strong>
              <span>{{ k.label }}</span>
            </li>
          {% endfor %}
        </ul>

        <!-- CTAs -->
        <div class="cta-bar" role="group" aria-label="Primary actions">
          <a class="btn primary" href="{{ DONATE }}" data-cta="donate" data-animate style="--d:.18s">Donate Now</a>
          <a class="btn ghost" href="#tiers" data-anchor="tiers" data-cta="tiers" data-animate style="--d:.22s">View Tiers</a>
          <button class="btn lite" data-share type="button" data-cta="share" data-animate style="--d:.26s" aria-label="Share fundraiser">ðŸ”— Share</button>
          <button class="btn lite" data-fastpay hidden type="button" aria-label="Fast pay" data-cta="fastpay" data-animate style="--d:.30s">ï£¿/â—Ž Pay</button>
          <button class="btn lite theme-toggle" aria-label="Toggle dark / light theme" type="button" data-cta="theme" data-animate style="--d:.34s">ðŸŒ—</button>
        </div>

        <!-- QUICK AMOUNTS -->
        <div class="quick-donate" role="group" aria-label="Quick amounts" data-animate style="--d:.38s">
          {% for amt in AMTS %}
            <a class="chip" href="{{ DONATE }}?amount={{ amt }}" data-amount="{{ amt }}" data-cta="quick">{{ money(amt) }}</a>
          {% endfor %}
        </div>

        <!-- TRUST -->
        <ul class="trust-row" aria-label="Trusted checkout & partners" data-animate style="--d:.42s">
          {% for t in TRUST_LOGOS %}
            <li><img class="trust-logo" src="{{ t.src }}" alt="{{ t.alt }}" loading="lazy" decoding="async"></li>
          {% endfor %}
        </ul>

        <!-- QR -->
        <div class="qr-card" role="region" aria-label="Scan to donate" data-animate style="--d:.46s">
          <div class="qr-frame" id="qr-frame">
            <img id="fc-qr" src="{{ QR }}" alt="Donate QR code" loading="lazy" decoding="async" width="160" height="160">
          </div>
          <div class="qr-info">
            <strong>Scan to Give</strong>
            <p>Secure checkout Â· Stripe / PayPal â€” press <kbd>D</kbd></p>
          </div>
        </div>

        <!-- MOBILE DONATE DOCK -->
        <div class="donate-dock" data-dock hidden>
          <div class="dock-inner">
            <div class="dock-progress">
              <div class="mini-ring" style="--pct: {{ PCT }}"><span></span></div>
              <div class="dock-meta">
                <strong class="js-raised" data-count data-currency="{{ CURRENCY }}" data-locale="{{ LOCALE }}" data-to="{{ RAISED }}">{{ money(RAISED) }}</strong>
                <small>/ <span class="js-goal" data-count data-currency="{{ CURRENCY }}" data-locale="{{ LOCALE }}" data-to="{{ GOAL }}">{{ money(GOAL) }}</span></small>
              </div>
            </div>
            <a class="btn primary" href="{{ DONATE }}" data-cta="dock-donate">Donate</a>
          </div>
        </div>
      </div>
    </div>
  </div>
  <p id="hero-live" class="u-sr-only" aria-live="polite">Progress ready.</p>
</section>

<style {{ nonce_attr() }}>
/* ========== FundChamps Hero â€” unified, lint-clean, no clipping ========== */

/* Theme tokens */
#fc-hero{
  --accent: {{ ACC }};
  --fg:#f8fafc; --muted:#9aa3af; --hair:#0000001a;           /* ~#ffffff1f on dark bg */
  --bg:#0b1020; --surface:#14192a; --glass: rgb(255 255 255 / 6%);
  --gap:1.5rem; --container-max:1360px; --ease:cubic-bezier(.4,0,.2,1);
  --shadow-xl: 0 16px 64px #0008, 0 2px 32px #0004;
  --radius:16px; --radius-sm:10px;

  /* hero layout tokens */
  --hero-media-min: 600px;   /* was 680px */
  --hero-copy-min:  380px;   /* was 420px */

  color:var(--fg);
  font-family: ui-sans-serif, system-ui, -apple-system, "Inter", Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
}
:root{ color-scheme: dark; }
html[data-theme="light"] #fc-hero{ --bg:#fff; --surface:#f6f7fb; --fg:#0d1117; --muted:#4b5563; --hair:#00000014; }

/* Layout shell */
.band--hero{ padding: calc(1.25rem + env(safe-area-inset-top)) var(--gap) calc(1.25rem + env(safe-area-inset-bottom)); max-width:var(--container-max); margin-inline:auto; }
.band--wide{ padding-top: clamp(.75rem, 2.2vw, 1.25rem); }

/* Frame (container-query target) */
.hero-frame{
  background:
    radial-gradient(1200px 400px at 8% 94%, color-mix(in srgb, var(--accent) 14%, transparent), transparent 60%),
    radial-gradient(1100px 360px at 96% 7%,  color-mix(in srgb, var(--accent) 10%, transparent), transparent 70%),
    var(--bg);
  border:1px solid var(--hair);
  border-radius:var(--radius);
  box-shadow:var(--shadow-xl);
  position:relative; isolation:isolate;

  /* Important: donâ€™t hard-clip children, but keep rounded corners */
  overflow:hidden;

  /* Container-query so the hero adapts to its own width (not viewport) */
  container-type:inline-size;
  container-name:hero;
}

/* Grid */
.hero-inner{
  display:grid; gap:clamp(1.2rem, 3vw, 2rem);
  grid-template-columns:
    minmax(0, 1.45fr) minmax(0, .9fr);
  align-items:center;
  padding:clamp(1rem, 3vw, 2rem);
}
/* Allow grid children to shrink instead of forcing overflow */
.hero-inner> *{ min-width:0; min-height:0; }

/* Fallback: one column a bit earlier on narrow laptops */
@media (max-width:1050px){ .hero-inner{ grid-template-columns:1fr; } }

/* Container-query refinements */
@container hero (min-width:1240px){
  #fc-hero.hero--xl .hero-inner{
    grid-template-columns:
      minmax(var(--hero-media-min), 1.45fr)
      minmax(var(--hero-copy-min),  .90fr);
    column-gap:clamp(1rem, 2.4vw, 2rem);
  }
}
@container hero (min-width:980px) and (max-width:1239px){
  #fc-hero.hero--xl .hero-inner{ grid-template-columns:minmax(520px,1.2fr) minmax(360px,.8fr); }
}
@container hero (max-width:979px){
  #fc-hero.hero--xl .hero-inner{ grid-template-columns:1fr; }
}

/* Media */
.hero-media{ margin:0; position:relative; display:grid; gap:1rem; z-index:1; }
.hero-img{
  width:100%; height:auto; aspect-ratio:16/9; object-fit:cover; border-radius:var(--radius);
  background: linear-gradient(180deg, #0c1220, var(--bg));
  box-shadow: 0 12px 50px #0006;
  filter: contrast(1.06) saturate(1.04);
}

/* Progress rail */
.hero-rail{ display:grid; gap:.6rem; position:relative; }
.hero-rail__bar{
  --pct: 0%;
  height:.7rem; background:color-mix(in srgb, var(--fg) 8%, transparent);
  border-radius:999px; border:1px solid color-mix(in srgb, var(--fg) 6%, transparent);
  overflow:hidden; position:relative;
}
.hero-rail__fg{
  position:absolute; inset:0; width:var(--pct);
  background:linear-gradient(90deg, color-mix(in srgb, var(--accent) 92%, #fff), var(--accent));
  box-shadow:0 6px 24px color-mix(in srgb, var(--accent) 30%, transparent);
  transition:width .6s cubic-bezier(.2,.7,.2,1);
}
.hero-rail__bar::after{
  content:""; position:absolute; inset:0; transform:translateX(-100%);
  background:linear-gradient(90deg, transparent, color-mix(in srgb, var(--accent) 40%, #fff 10%) 40%, transparent 70%);
  animation:sweep 2.4s linear infinite; pointer-events:none;
}
@keyframes sweep{ 0%{ transform:translateX(-100%);} 100%{ transform:translateX(100%);} }
.hero-rail__meta{ display:flex; justify-content:space-between; gap:.75rem; color:var(--muted); font-weight:800; }
.hero-rail__pct{ color:var(--accent); font-weight:900; }

/* Copy */
.hero-copy{ display:grid; gap:.9rem; }
.badge{
  display:inline-flex; gap:.5rem; align-items:center;
  background:color-mix(in srgb, var(--fg) 6%, transparent);
  border:1px solid color-mix(in srgb, var(--fg) 10%, transparent);
  padding:.4rem .7rem; border-radius:.7rem; font-weight:900; color:var(--accent);
}
.badge-dot{ width:.8rem; height:.8rem; fill:currentColor; filter:drop-shadow(0 0 8px color-mix(in srgb, var(--accent) 45%, transparent)); }
.headline{ font-size:clamp(2rem, 3.6vw, 3rem); letter-spacing:-.015em; margin:0; font-weight:1000; text-wrap:balance; }
.hl-accent{ color:var(--accent); text-shadow:0 2px 12px color-mix(in srgb, var(--accent) 22%, transparent); }
.hero-tag{ color:#99f6ff; font-weight:600; margin-top:-.3rem; }
.sub{ color:var(--muted); max-width:60ch; }

/* KPIs */
.kpi-list{ display:grid; grid-template-columns:repeat(3, minmax(0,1fr)); gap:.8rem; padding:0; margin:.4rem 0 0; list-style:none; }
.kpi-list li{
  background:linear-gradient(145deg, rgb(255 255 255 / 6%), rgb(255 255 255 / 2%));
  border:1px solid var(--hair); border-radius:var(--radius-sm); padding:.8rem; text-align:center; display:grid; gap:.2rem;
  transition: transform .25s ease, box-shadow .25s ease; will-change:transform;
  box-shadow: inset 0 1px 0 rgb(255 255 255 / 7%), 0 10px 30px #0006;
}
.kpi-list li:hover{ transform: translateY(-3px); box-shadow: 0 10px 30px #0008; }
.kpi-list strong{ color:var(--accent); font-size:1.35rem; font-weight:900; }
.kpi-list span{ color:var(--muted); font-weight:800; font-size:.95rem; }
@media (max-width:700px){ .kpi-list{ grid-template-columns:1fr; } }

/* CTAs */
.cta-bar{ display:flex; flex-wrap:wrap; gap:.6rem; margin-top:.4rem; }
.btn{
  display:inline-flex; align-items:center; justify-content:center; gap:.55em;
  border-radius:999px; padding:.78rem 1.35rem; font-weight:900; cursor:pointer;
  transition: transform .18s ease, box-shadow .18s ease, filter .18s ease;
}
.btn.primary{
  background:linear-gradient(92deg, var(--accent), color-mix(in srgb, var(--accent) 78%, #fff) 95%);
  color:#121212; border:none;
  box-shadow:0 10px 30px color-mix(in srgb, var(--accent) 30%, transparent);
  position:relative;
}
.btn.primary::after{
  content:""; position:absolute; inset:0; border-radius:inherit; pointer-events:none;
  background:linear-gradient(180deg, rgb(255 255 255 / 50%), transparent 38%);
  mix-blend-mode:overlay; opacity:.6;
}
.btn.ghost{ background:transparent; border:2px solid var(--accent); color:var(--accent); }
.btn.lite{ background:color-mix(in srgb, var(--fg) 6%, transparent); border:1px solid color-mix(in srgb, var(--fg) 10%, transparent); color:var(--fg); }
.btn:hover{ transform:translateY(-2px); box-shadow:0 10px 30px color-mix(in srgb, var(--accent) 18%, transparent); }
.btn:active{ transform:none; box-shadow:none; filter:saturate(.96) brightness(.98); }

/* Quick donate chips */
.quick-donate{ display:flex; flex-wrap:wrap; gap:.5rem; }
.chip{
  display:inline-flex; align-items:center; gap:.4rem; padding:.5rem .8rem; border-radius:.7rem; font-weight:900;
  background:color-mix(in srgb, var(--fg) 6%, transparent); border:1px solid color-mix(in srgb, var(--fg) 10%, transparent);
  transition: transform .16s ease, box-shadow .16s ease;
  max-width:100%;
}
.chip:hover{ transform:translateY(-1px); box-shadow:0 8px 18px color-mix(in srgb, var(--accent) 18%, transparent); }

/* Trust & QR */
.trust-row{ display:flex; gap:.8rem; align-items:center; list-style:none; padding:0; margin:.6rem 0 0; opacity:.9; }
.trust-logo{ height:22px; width:auto; filter:grayscale(100%); opacity:.85; }
.qr-card{
  display:flex; gap:.8rem; align-items:center; background:color-mix(in srgb, #22d3ee 9%, #18181b 91%);
  border:1px solid color-mix(in srgb, #22d3ee 15%, transparent); border-radius:.9rem; padding:.6rem .8rem; box-shadow:0 4px 20px #22d3ee33;
}
.qr-frame{ background:#fff; border-radius:.5rem; padding:.35rem; }
.qr-info strong{ color:#22d3ee; }

/* Donor ticker */
.ticker-wrap{ overflow:hidden; mask-image:linear-gradient(to right, transparent, #000 7%, #000 93%, transparent); }
.donor-ticker{ display:flex; gap:1.1rem; padding:.3rem 0; font-weight:800; color:#fde047; white-space:nowrap; will-change:transform; }
.donor-ticker:hover{ animation-play-state:paused; }
.ghost{ opacity:.7; }

/* Mobile donate dock */
.donate-dock[hidden]{ display:none !important; }
.dock-inner{
  display:flex; gap:.8rem; align-items:center; justify-content:space-between;
  background:#0c111a; border:1px solid var(--hair); box-shadow:0 10px 26px #0006; padding:.6rem;
  border-radius:.8rem; position:sticky; bottom:1rem;
}
.mini-ring{ --pct:0; width:34px; height:34px; border-radius:999px; background:conic-gradient(var(--accent) calc(var(--pct)*1%), #293040 0); display:grid; place-items:center; }
.mini-ring> span{ width:22px; height:22px; border-radius:50%; background:#0c111a; box-shadow:inset 0 0 0 2px #111; }
.dock-meta{ color:var(--muted); font-weight:800; }

/* A11y + motion */
.u-sr-only, .sr-only{
  position:absolute !important; width:1px; height:1px; padding:0; margin:-1px;
  overflow:hidden; clip-path:inset(50%); white-space:nowrap; border:0;
}
:focus-visible{ outline:2px solid color-mix(in srgb, var(--accent) 65%, #fff 10%); outline-offset:3px; }
[data-animate]{ opacity:0; transform:translateY(18px); }
[data-animate].in{ opacity:1; transform:none; transition: opacity .6s var(--ease), transform .6s var(--ease); }

@media (hover:hover) and (pointer:fine){
  .hero-img{ transform-origin:center; animation: ken 18s ease-in-out infinite alternate; }
  @keyframes ken{ 0%{ transform: scale(1) translate3d(0,0,0);} 100%{ transform: scale(1.06) translate3d(0,-1.5%,0);} }
}
@media (prefers-reduced-motion: reduce){
  .hero-img{ animation:none !important; } .hero-rail__fg{ transition:none !important; }
  [data-animate]{ opacity:1 !important; transform:none !important; transition:none !important; }
}

/* XL visual tuning */
#fc-hero.hero--xl .hero-media{ align-self:stretch; }
#fc-hero.hero--xl .hero-img{ min-height:clamp(560px, 56vh, 720px); }
#fc-hero.hero--xl.band--hero{ max-width:var(--container-max, 1400px); }
</style>

<script {{ nonce_attr() }} type="module">
(() => {
  const sec = document.getElementById('fc-hero'); if (!sec || sec.__wired) return; sec.__wired = true;
  const reduce = matchMedia('(prefers-reduced-motion: reduce)').matches;

  // Refs
  const live = sec.querySelector('#hero-live');
  const railBar = sec.querySelector('.hero-rail__bar');
  const railFG  = sec.querySelector('.hero-rail__fg');
  const raisedEls = sec.querySelectorAll('.js-raised');
  const goalEls   = sec.querySelectorAll('.js-goal');
  const pctEl     = sec.querySelector('.js-pct');
  const dock      = sec.querySelector('[data-dock]');
  const shareBtn  = sec.querySelector('[data-share]');
  const fastBtn   = sec.querySelector('[data-fastpay]');
  const tickerUL  = sec.querySelector('.donor-ticker');
  const donateURL = sec.dataset.donate || '/donate';
  const apiURL    = sec.dataset.api || '';
  const tickerURL = sec.dataset.ticker || '';
  const endISO    = sec.dataset.end || '';
  const CURRENCY  = sec.dataset.currency || 'USD';
  const LOCALE    = sec.dataset.locale || 'en-US';

  // Utils
  const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
  const fmtMoney = (n) => { try { return new Intl.NumberFormat(LOCALE, { style:'currency', currency:CURRENCY, maximumFractionDigits:0 }).format(n); } catch { return '$' + Math.round(+n||0).toLocaleString(); } };
  const fmtTime = (ms) => { const d = Math.floor(ms/86400000), h = Math.floor((ms%86400000)/3600000); return `${d}d ${h}h`; };

  // State
  let GOAL = Math.max(1, Number(sec.dataset.goal || 0));
  let RAISED = Math.max(0, Number(sec.dataset.raised || 0));

  // Reveal on intersect
  if ('IntersectionObserver' in window){
    const io = new IntersectionObserver((ents)=>ents.forEach(e=>{ if (e.isIntersecting){ e.target.classList.add('in'); io.unobserve(e.target); } }), { threshold:.15 });
    sec.querySelectorAll('[data-animate]:not(.in)').forEach(el=>io.observe(el));
  } else { sec.querySelectorAll('[data-animate]').forEach(el=>el.classList.add('in')); }

  // Paint
  function paint() {
    const pct = clamp(Math.round(RAISED / GOAL * 100), 0, 100);
    railBar?.setAttribute('aria-valuemax', String(GOAL));
    railBar?.setAttribute('aria-valuenow', String(RAISED));
    railBar?.setAttribute('aria-label', `${fmtMoney(RAISED)} of ${fmtMoney(GOAL)} raised`);
    if (railFG) railFG.style.width = pct + '%';
    raisedEls.forEach(el => el.textContent = fmtMoney(RAISED));
    goalEls.forEach(el => el.textContent  = fmtMoney(GOAL));
    if (pctEl) pctEl.textContent = pct + '%';
    const ring = sec.querySelector('.mini-ring'); if (ring) ring.style.setProperty('--pct', (pct/100).toString());
    live && (live.textContent = `Progress updated: ${pct}%`);
    window.dispatchEvent(new CustomEvent('fcx:progress', { detail:{ raised:RAISED, goal:GOAL, pct } }));
    if (window.dataLayer) window.dataLayer.push({ event:'progress_paint', raised:RAISED, goal:GOAL, pct });
  }
  paint();

  // Countdown
  (function countdown(){
    const el = sec.querySelector('#countdown'); if (!el || !endISO) return;
    const end = new Date(endISO); if (isNaN(end)) return;
    const tick = () => {
      const ms = Math.max(0, end - new Date());
      el.textContent = ms ? `Ends in ${fmtTime(ms)}` : 'Campaign ended';
    };
    tick(); setInterval(tick, 60_000);
  })();

  // Dock visibility
  if ('IntersectionObserver' in window && dock) {
    const io = new IntersectionObserver((ents)=>{ const e=ents[0]; dock.hidden = !e || e.isIntersecting; }, { threshold:0.05 });
    io.observe(sec);
  }

  // Smooth anchors
  document.addEventListener('click', (e)=>{
    const a = e.target.closest('a[data-anchor]'); if (!a) return;
    const id = '#' + (a.getAttribute('data-anchor') || '').replace(/^#/, '');
    const el = document.querySelector(id); if (!el) return;
    e.preventDefault(); el.scrollIntoView({ behavior: reduce?'auto':'smooth', block:'start' });
  }, { passive:false });

  // Keyboard shortcuts
  addEventListener('keydown', (e)=>{
    if (e.defaultPrevented) return;
    const k = e.key?.toLowerCase?.() || '';
    if (k==='d') location.assign(donateURL);
    if (k==='s') triggerShare();
  }, { passive:true });

  // Share
  async function triggerShare(){
    const data = { title: document.title, text: `Support {{ TEAM|e }}`, url: location.href };
    try { if (navigator.share) return await navigator.share(data); } catch {}
    try { await navigator.clipboard.writeText(location.href); shareBtn?.setAttribute('aria-label','Link copied!'); setTimeout(()=> shareBtn?.setAttribute('aria-label','Share fundraiser'), 1500); } catch {}
  }
  shareBtn?.addEventListener('click', triggerShare, { passive:true });

  // PaymentRequest fast pay (UX demo: redirects to donate after success)
  if (isSecureContext && 'PaymentRequest' in window && fastBtn){
    fastBtn.hidden = false;
    fastBtn.addEventListener('click', async ()=>{
      try {
        const details = { total:{ label:'Donation', amount:{ currency:CURRENCY, value:'50.00' } } };
        const req = new PaymentRequest([{ supportedMethods:'basic-card' }], details);
        const resp = await req.show(); await resp.complete('success');
        location.assign(new URL(donateURL, location.origin).toString());
      } catch {}
    }, { passive:true });
  }

  // Donor ticker
  async function loadTicker(){
    if (!tickerUL || !tickerURL) return;
    try {
      const r = await fetch(tickerURL, { headers:{ accept:'application/json' }, cache:'no-store' });
      if (!r.ok) throw 0; const d = await r.json();
      if (!Array.isArray(d) || !d.length) return;
      tickerUL.innerHTML = d.slice(0, 24).map(ev => {
        const name = String(ev.name || 'Donor'); const amt = fmtMoney(ev.amount || 0);
        return `<li>ðŸŽ‰ <strong>${name}</strong> gave <strong>${amt}</strong></li>`;
      }).join('<li aria-hidden="true">â€¢</li>');
      let x = 0, paused = false;
      tickerUL.addEventListener('mouseenter', ()=> paused=true);
      tickerUL.addEventListener('mouseleave', ()=> paused=false);
      (function loop(){
        if (!reduce && !paused){ x -= 0.45; tickerUL.style.transform = `translateX(${x}px)`; if (Math.abs(x)> (tickerUL.scrollWidth/2)) x = 0; }
        requestAnimationFrame(loop);
      })();
    } catch {}
  }
  loadTicker();

  // ETag polling
  let etag = null, backoff = 4000, maxBackoff = 30000;
  async function poll(){
    if (!apiURL) return;
    try{
      const res = await fetch(apiURL, { headers: Object.assign({ accept:'application/json' }, etag? { 'If-None-Match': etag } : {}), cache:'no-store' });
      if (res.status === 304) { /* unchanged */ }
      else if (res.ok){
        etag = res.headers.get('ETag');
        const j = await res.json();
        if (typeof j.goal==='number')   GOAL   = Math.max(1, Number(j.goal));
        if (typeof j.raised==='number') RAISED = Math.max(0, Number(j.raised));
        paint();
      }
      backoff = 5000;
    } catch { backoff = Math.min(maxBackoff, Math.round(backoff*1.6)); }
    finally { setTimeout(poll, backoff); }
  }
  setTimeout(poll, 1500);

  // Count-up
  function moneyFmt(v, cur=CURRENCY, loc=LOCALE){
    try { return new Intl.NumberFormat(loc, { style:'currency', currency:cur, maximumFractionDigits:0 }).format(v); }
    catch { return '$' + Math.round(+v||0).toLocaleString(); }
  }
  function countTo(el, to){
    const from = Number(el.dataset.from ?? el.textContent.replace(/[^\d.-]/g,'')) || 0;
    const dur  = Number(el.dataset.dur || 900);
    const ease = t => 1 - Math.pow(1 - t, 3);
    const prefix = el.dataset.prefix || ''; const suffix = el.dataset.suffix || '';
    const currency = el.dataset.currency || ''; const locale = el.dataset.locale || LOCALE;
    const start = performance.now();
    function tick(now){
      const t = Math.min(1, (now-start)/dur);
      const v = from + (to - from) * (reduce? 1 : ease(t));
      el.textContent = currency ? moneyFmt(v, currency, locale) : prefix + Math.floor(v).toLocaleString(locale) + suffix;
      if (t<1) requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);
  }
  if ('IntersectionObserver' in window){
    const nobs = new IntersectionObserver((ents)=>ents.forEach(e=>{
      if (!e.isIntersecting) return; const el=e.target; const to=Number(el.dataset.to||0);
      el.dataset.from = el.dataset.from ?? '0'; countTo(el, to); nobs.unobserve(el);
    }), { threshold:.25 });
    sec.querySelectorAll('[data-count]').forEach(el=>nobs.observe(el));
  } else { sec.querySelectorAll('[data-count]').forEach(el=>countTo(el, Number(el.dataset.to||0))); }

  // Animate progress on external updates
  window.addEventListener('fcx:progress', (e)=>{
    const { raised, goal, pct } = e.detail || {};
    if (typeof raised==='number') raisedEls.forEach(el => countTo(el, raised));
    if (typeof goal  ==='number') goalEls.forEach(el => countTo(el, goal));
    if (typeof pct   ==='number' && pctEl) countTo(pctEl, pct);
    if (typeof pct   ==='number' && railFG) railFG.style.width = clamp(Math.round(pct),0,100) + '%';
  });

  // Theme toggle
  sec.querySelector('.theme-toggle')?.addEventListener('click', ()=>{
    const html = document.documentElement; const key = 'fcx:theme';
    const next = (localStorage.getItem(key) || 'dark') === 'dark' ? 'light' : 'dark';
    localStorage.setItem(key, next); html.dataset.theme = next;
  }, { passive:true });
})();
</script>

