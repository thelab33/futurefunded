
{# FF: Logo fallback helper #}
{% set _org_logo = _org_logo|default(url_for('static', filename='images/fundchamps-fc.svg')) %}


<!--
üíé FUTUREFUNDED GO-LIVE CHECKLIST (UI/UX)

1. LOGO wired from Flask context (_org_logo)
2. Accessibility: skiplinks, focus rings, ARIA
3. Responsive test on mobile/tablet/desktop
4. Powered by FutureFunded badge present
5. PWA icons + manifest verified
6. No overflow / no bleed / theme verified
-->

{# ================= FCX SCOREBOARD ULTRA ‚Äî v2.5 SaaS/Embed Ready ================= #}
{% set NONCE = NONCE if NONCE is defined else (csp_nonce() if csp_nonce is defined else '') %}
{% macro nonce_attr() -%}{% if NONCE %}nonce="{{ NONCE }}"{% endif %}{%- endmacro %}
{% set EMBED = EMBED | default(false) %}

{# -------- Context Fallbacks for SaaS/white-label (never hardcode!) -------- #}
{% set TEAM        = TEAM_NAME or (team.name if team is defined and team.name else (team.team_name if team is defined and team.team_name else 'FundChamps')) %}
{% set GOAL        = (fundraising_goal if fundraising_goal is defined else (GOAL if GOAL is defined else 50000))|int %}
{% set RAISED      = (funds_raised if funds_raised is defined else (RAISED if RAISED is defined else 0))|int %}
{% set CHIPS       = quick_amounts if quick_amounts is defined and quick_amounts else [25,50,100,250] %}
{% set CURRENCY    = currency|default('USD', true) %}
{% set LOCALE      = locale|default('en-US', true) %}
{% set THEME       = THEME|default('auto', true) %}
{% set ACCENT      = ACCENT|default('#facc15') %}
{% set IMPACT_DESC = IMPACT_DESC|default('Every $100 = 1 week of gym time for 8 kids', true) %}
{% set DEADLINE_ISO= DEADLINE_ISO|default('', true) %}
{% set DAYS_LEFT   = days_left|default('30 days', true) %}
{% set DONATE_URL  = (DONATE_URL if DONATE_URL is defined and DONATE_URL else
  (HREF_DONATE if HREF_DONATE is defined and HREF_DONATE else
    (stripe_payment_link if (stripe_payment_link is defined and stripe_payment_link) else '/donate'))) %}
{% set CHECKOUT_URL   = CHECKOUT_URL|default('/api/create-checkout', true) %}
{% set WS_URL         = WS_URL|default('', true) %}
{% set LEADERBOARD_SRC= LEADERBOARD_SRC|default('/api/leaderboard/top', true) %}
{% set TICKER_SRC     = TICKER_SRC|default('/api/donors/recent', true) %}
{% set TOTALS_SRC     = TOTALS_SRC|default('/api/fund/totals', true) %}
{% set SCORE_ID       = SCORE_ID|default('fcx-scoreboard-ultra') %}

<aside class="fcx-scoreboard-ultra{% if EMBED %} is-embed{% endif %}"
       id="{{ SCORE_ID }}"
       role="region"
       aria-labelledby="{{ SCORE_ID }}-title"
       data-team="{{ TEAM|e }}"
       data-goal="{{ GOAL|int }}"
       data-raised="{{ RAISED|int }}"
       data-donate-url="{{ DONATE_URL|e }}"
       data-currency="{{ CURRENCY|e }}"
       data-locale="{{ LOCALE|e }}"
       data-theme="{{ THEME|e }}"
       data-checkout="{{ CHECKOUT_URL|e }}"
       data-ws="{{ WS_URL|e }}"
       data-leaderboard-src="{{ LEADERBOARD_SRC|e }}"
       data-ticker-src="{{ TICKER_SRC|e }}"
       data-totals-src="{{ TOTALS_SRC|e }}"
       style="--accent: {{ ACCENT }}; --gap: .6rem;">
  <div class="fcx-inner">
    <!-- ===== Progress Ring + Avatars ===== -->
    <div class="fcx-top">
      <div class="fcx-ring-wrap" aria-hidden="false">
        <svg viewBox="0 0 120 120" class="fcx-ring" width="120" height="120" aria-hidden="true">
          <defs>
            <linearGradient id="{{ SCORE_ID }}-grad" x1="0" x2="1">
              <stop offset="0%"  stop-color="var(--accent)" />
              <stop offset="65%" stop-color="#fff7bf" />
              <stop offset="100%" stop-color="color-mix(in srgb, var(--accent) 70%, #fff)" />
            </linearGradient>
          </defs>
          <circle class="ring-bg" cx="60" cy="60" r="52" />
          <circle class="ring-fg" cx="60" cy="60" r="52" stroke="url(#{{ SCORE_ID }}-grad)" />
        </svg>
        <div class="fcx-center">
          <div class="fcx-pct-wrap">
            <span id="{{ SCORE_ID }}-pct-large" class="fcx-pct" aria-live="polite">0%</span>
            <small class="fcx-pct-sub">of goal</small>
          </div>
          <div class="fcx-avatars" id="{{ SCORE_ID }}-avatars" aria-label="Recent donors"></div>
        </div>
      </div>

      <!-- ===== Meta: Team/Impact/Stats ===== -->
      <div class="fcx-meta">
        <div class="fcx-impact" role="note" aria-live="polite">
          <span class="impact-emoji" aria-hidden="true">‚ö°</span>
          <span id="{{ SCORE_ID }}-impact-desc">{{ IMPACT_DESC }}</span>
        </div>
        <h2 id="{{ SCORE_ID }}-title" class="fcx-title">
          <span>Be the Assist.</span> <span class="accent">Fund Their Win.</span>
        </h2>
        <div class="fcx-stats" aria-describedby="{{ SCORE_ID }}-meter">
          <div class="fcx-stats-main">
            <span id="{{ SCORE_ID }}-raised" class="fcx-raised">${{ "{:,.0f}".format(RAISED) }}</span>
            <span class="fcx-sep">/</span>
            <span id="{{ SCORE_ID }}-goal" class="fcx-goal">${{ "{:,.0f}".format(GOAL) }}</span>
            <span class="fcx-inline-pct">(<span id="{{ SCORE_ID }}-pct-inline">0</span>%)</span>
          </div>
          <div class="fcx-deadline">
            <span class="label">üèÅ Ends in:</span>
            <time id="{{ SCORE_ID }}-deadline" datetime="{{ DEADLINE_ISO }}">{{ DAYS_LEFT }}</time>
          </div>
          <div id="{{ SCORE_ID }}-gap" class="fcx-gap" aria-live="polite">Only ${{ "{:,.0f}".format(GOAL - RAISED) }} to go!</div>
        </div>
      </div>
    </div>

    <!-- ===== Meter ===== -->
    <div id="{{ SCORE_ID }}-meter" class="fcx-meter" role="progressbar"
         aria-valuemin="0" aria-valuemax="{{ GOAL|int }}" aria-valuenow="{{ RAISED|int }}"
         aria-valuetext="0% complete" aria-label="Fundraising progress">
      <div class="fcx-meter-track">
        <div class="fcx-meter-fill" style="width:0%"></div>
      </div>
      <div class="fcx-tier-markers" aria-hidden="true">
        <span data-tier="bronze">ü•â $1k</span>
        <span data-tier="silver">ü•à $5k</span>
        <span data-tier="gold">ü•á $10k</span>
        <span data-tier="stretch">üöÄ Stretch</span>
      </div>
    </div>

    <!-- ===== Donate Chips ===== -->
    <div class="fcx-donate">
      <div class="fcx-chips" role="group" aria-label="Quick donate amounts">
        {% for a in CHIPS %}
        <button class="fcx-chip" type="button" data-amt="{{ a }}" aria-pressed="false" data-cta="chip-{{ a }}">+${{ a }}
          <em>
            {% if a==25 %}¬∑ Meals
            {% elif a==50 %}¬∑ Jersey
            {% elif a==100 %}¬∑ Gym Week
            {% else %}¬∑ Travel
            {% endif %}
          </em>
        </button>
        {% endfor %}
      </div>
      <div class="fcx-cta-row">
        <button id="{{ SCORE_ID }}-donate-btn" class="fcx-cta fcx-cta-primary" data-checkout data-cta="donate-now">Donate Now ‚Üí</button>
        <button id="{{ SCORE_ID }}-pr" class="fcx-cta fcx-cta-payreq" hidden aria-label="Pay with wallet" data-cta="payreq">Pay ‚Ä¢ Apple/Google</button>
        <label class="fcx-monthly"><input id="{{ SCORE_ID }}-monthly" type="checkbox" aria-label="Make it monthly"> Make it monthly</label>
      </div>
    </div>

    <!-- ===== Live Ticker ===== -->
    <div id="{{ SCORE_ID }}-ticker" class="fcx-ticker" role="region" aria-label="Recent donor activity">
      <div id="{{ SCORE_ID }}-ticker-track" class="fcx-ticker-track" aria-live="polite">
        <span class="fcx-ticker-ghost">üéâ Be the first donor ‚Äî every dollar counts!</span>
      </div>
      <button id="{{ SCORE_ID }}-ticker-pause" class="fcx-ticker-pause" aria-pressed="false" aria-label="Pause updates" data-cta="ticker-pause">‚ùö‚ùö</button>
    </div>

    <!-- ===== Leaderboard ===== -->
    <details class="fcx-leaderboard" open>
      <summary class="fcx-leaderboard-title">üèÜ Top Sponsors</summary>
      <ul id="{{ SCORE_ID }}-sponsors" class="fcx-sponsor-list" aria-live="polite" aria-busy="true">
        <li class="skeleton">Loading‚Ä¶</li>
      </ul>
      <a class="fcx-see-all" href="/leaderboard" data-cta="see-leaderboard">See Full Leaderboard ‚Üí</a>
    </details>

    <!-- ===== Footer: CTAs/Brand ===== -->
    <footer class="fcx-footer">
      <button class="fcx-share" data-share aria-label="Share this fundraiser" data-cta="share-scoreboard">üîó Share</button>
      <a class="fcx-ghost" href="/impact" data-cta="view-impact">View Impact</a>
      <a class="fcx-ghost" href="/become-sponsor" data-cta="become-sponsor">Become Sponsor</a>
      <div class="fcx-powered">Powered by <a href="https://fundchamps.org" target="_blank" rel="noopener">FundChamps</a></div>
    
<!-- FF: Powered by badge -->
<div class="ff-poweredby">
  Powered by <strong>FutureFunded</strong>
</div>

</footer>
    <div id="{{ SCORE_ID }}-live" class="sr-only" aria-live="polite"></div>
  </div>
</aside>

<style {{ nonce_attr() }}>
/* =========================
   FCX SCOREBOARD ULTRA v2.5
   =========================
   - Instance-safe: all CSS vars + no global selectors
   - Dark-mode, white-label ready, highly embeddable
   - A11y, reduced motion, forced color compatible
   - Premium: shadows, gradients, focus rings
   - Easy to extend (add .fcx-<something>)
============================ */

/* === Base Container === */
.fcx-scoreboard-ultra {
  --accent: {{ ACCENT }};
  --bg: var(--header-bg, #0b0c11);
  --fg: var(--header-fg, #f8fafc);
  --muted: var(--header-muted, #94a3b8);
  --hair: color-mix(in srgb, var(--fg) 10%, transparent);

  color: var(--fg);
  background: linear-gradient(180deg, color-mix(in srgb, var(--bg) 95%, #000), var(--bg));
  border-radius: 16px;
  border: 1px solid var(--hair);
  box-shadow: 0 8px 36px #0008;
  max-width: min(620px, 100%);
  margin-inline: auto;
  font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, sans-serif;
  container-type: inline-size;
  content-visibility: auto;
  contain-intrinsic-size: 700px 600px;
}

/* === Inner Layout === */
.fcx-inner { padding: clamp(14px,2.4vw,20px); display: grid; gap: .6rem; }
.fcx-top { display: grid; grid-template-columns: auto 1fr; gap: .6rem; align-items: center; }
@container (max-width:520px) { .fcx-top { grid-template-columns: 1fr; } }

/* === Progress Ring === */
.fcx-ring-wrap { width: 132px; aspect-ratio: 1; position: relative; display: grid; place-items: center; margin-inline: auto; }
.fcx-ring { width: 120px; height: 120px; }
.ring-bg { fill: none; stroke: color-mix(in srgb, var(--fg) 8%, transparent); stroke-width: 12; }
.ring-fg { fill: none; stroke-width: 12; stroke-linecap: round; stroke-dasharray: 327; stroke-dashoffset: 327; transition: stroke-dashoffset .9s cubic-bezier(.2,.8,.2,1); filter: drop-shadow(0 2px 18px color-mix(in srgb, var(--accent) 35%, transparent)); }

/* === Center (Progress % + Avatars) === */
.fcx-center { position: absolute; inset: 0; display: grid; place-items: center; text-align: center; pointer-events: none; }
.fcx-pct { font-weight: 900; font-size: 1.5rem; color: var(--accent); text-shadow: 0 1px 6px #000; }
.fcx-pct-sub { color: color-mix(in srgb, var(--fg) 70%, transparent); font-weight: 800; }
.fcx-avatars { position: absolute; left: 50%; bottom: -14px; transform: translateX(-50%); display: flex; gap: 0; pointer-events: auto; }
.fcx-avatar { width: 30px; height: 30px; border-radius: 50%; border: 2px solid var(--bg); background: #222; display: inline-flex; align-items: center; justify-content: center; font-weight: 900; margin-left: -10px; box-shadow: 0 6px 20px rgba(0,0,0,.45); }

/* === Meta, Title, Stats === */
.fcx-meta { min-width: 0; }
.fcx-impact { display: inline-flex; gap: .5rem; align-items: center; padding: .28rem .6rem; border-radius: .6rem; background: linear-gradient(90deg, color-mix(in srgb, var(--bg) 82%, #000), color-mix(in srgb, var(--bg) 70%, #111)); color: var(--accent); font-weight: 900; }
.fcx-title { margin: .25rem 0 0; font-weight: 900; font-size: clamp(1.05rem,1rem + .85vw,1.45rem); letter-spacing: -.01em; }
.fcx-title .accent { color: var(--accent); }
.fcx-stats { display: grid; gap: .35rem; margin-top: .45rem; }
.fcx-stats-main { display: flex; align-items: baseline; gap: .5rem; flex-wrap: wrap; }
.fcx-raised { font-weight: 900; font-size: 1.3rem; color: var(--accent); }
.fcx-goal { color: color-mix(in srgb, var(--fg) 75%, transparent); font-weight: 800; }
.fcx-sep { opacity: .65; }
.fcx-inline-pct { font-weight: 800; color: var(--accent); }
.fcx-deadline, .fcx-gap { color: var(--muted); font-weight: 800; }

/* === Meter === */
.fcx-meter { margin-top: .45rem; }
.fcx-meter-track { height: .6rem; background: color-mix(in srgb, var(--fg) 10%, transparent); border-radius: 999px; overflow: hidden; border: 1px solid color-mix(in srgb, var(--fg) 6%, transparent); }
.fcx-meter-fill { width: 0; height: 100%; background: linear-gradient(90deg, color-mix(in srgb, var(--accent) 92%, #fff), var(--accent)); transition: width .6s cubic-bezier(.2,.7,.2,1); box-shadow: 0 4px 18px color-mix(in srgb, var(--accent) 25%, transparent); }
.fcx-tier-markers { display: flex; justify-content: space-between; font-weight: 800; margin-top: .45rem; font-size: .86rem; color: color-mix(in srgb, var(--fg) 70%, transparent); }

/* === Donate (Chips/Actions) === */
.fcx-donate { display: flex; flex-direction: column; gap: .55rem; }
.fcx-chips { display: flex; flex-wrap: wrap; gap: .5rem; }
.fcx-chip { background: color-mix(in srgb, var(--fg) 6%, transparent); border: 1px solid color-mix(in srgb, var(--fg) 8%, transparent); color: var(--fg); padding: .46rem .68rem; border-radius: .7rem; font-weight: 900; cursor: pointer; display: inline-flex; gap: .5rem; align-items: center; user-select: none; }
.fcx-chip em { display: block; font-style: normal; font-weight: 700; opacity: .9; font-size: .84rem; }
.fcx-chip[aria-pressed="true"] { background: var(--accent); color: #111; border-color: transparent; }
.fcx-cta-row { display: flex; gap: .6rem; align-items: center; margin-top: .45rem; flex-wrap: wrap; }
.fcx-cta { padding: .6rem .9rem; border-radius: .7rem; font-weight: 900; cursor: pointer; border: 1px solid color-mix(in srgb, var(--fg) 8%, transparent); background: color-mix(in srgb, var(--fg) 6%, transparent); color: var(--fg); }
.fcx-cta-primary { background: linear-gradient(90deg,#fde047,#fbbf24); color: #111; border: none; box-shadow: 0 8px 28px color-mix(in srgb, var(--accent) 30%, transparent); }
.fcx-cta-payreq { background: color-mix(in srgb, var(--fg) 4%, transparent); }

/* === Live Ticker === */
.fcx-ticker { position: relative; border-radius: .7rem; overflow: hidden; background: color-mix(in srgb, var(--fg) 3%, transparent); border: 1px dashed color-mix(in srgb, var(--fg) 8%, transparent); }
.fcx-ticker-track { display: flex; gap: 1.1rem; padding: .5rem .7rem; white-space: nowrap; will-change: transform; font-weight: 900;
  -webkit-mask-image: linear-gradient(to right, transparent, #000 7%, #000 93%, transparent);
          mask-image: linear-gradient(to right, transparent, #000 7%, #000 93%, transparent); }
.fcx-ticker-pause { position: absolute; right: .4rem; top: .28rem; border-radius: .5rem; background: color-mix(in srgb, var(--fg) 4%, transparent); padding: .18rem .36rem; border: 1px solid color-mix(in srgb, var(--fg) 8%, transparent); cursor: pointer; }

/* === Leaderboard === */
.fcx-leaderboard { background: color-mix(in srgb, var(--bg) 85%, #000); border-radius: .7rem; padding: .55rem; border: 1px solid color-mix(in srgb, var(--fg) 6%, transparent); }
.fcx-sponsor-list { list-style: none; padding: 0; margin: 0; display: grid; gap: .45rem; }
.fcx-sponsor-list li { display: flex; justify-content: space-between; align-items: center; padding: .46rem .6rem; border-radius: .6rem; background: color-mix(in srgb, var(--bg) 86%, #000); font-weight: 900; border-left: 4px solid var(--accent); }
.skeleton { height: 34px; background: linear-gradient(90deg,#17181c,#222428,#17181c); background-size: 200% 100%; animation: shimmer 1.1s linear infinite; }

/* === Footer === */
.fcx-footer { display: flex; gap: .6rem; align-items: center; justify-content: space-between; margin-top: .6rem; flex-wrap: wrap; }
.fcx-share { background: color-mix(in srgb, var(--fg) 4%, transparent); border: 1px solid color-mix(in srgb, var(--fg) 8%, transparent); padding: .42rem .62rem; border-radius: .55rem; font-weight: 900; color: var(--accent); cursor: pointer; }
.fcx-ghost { color: color-mix(in srgb, var(--fg) 80%, transparent); text-decoration: none; padding: .42rem .62rem; border-radius: .55rem; background: color-mix(in srgb, var(--fg) 3%, transparent); border: 1px solid color-mix(in srgb, var(--fg) 6%, transparent); }
.fcx-powered { font-size: .96rem; color: var(--muted); margin-left: .5rem; }

.sr-only { position: absolute !important; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
:focus-visible { outline: 2px solid color-mix(in srgb, var(--accent) 65%, #fff 10%); outline-offset: 2px; }

@keyframes shimmer { 0% { background-position:200% 0 } 100% { background-position: -200% 0 } }
@media (prefers-reduced-motion: reduce) { .fcx-ticker-track, .ring-fg, .fcx-meter-fill { transition: none!important; animation: none!important; } }
@media (forced-colors: active) {
  .fcx-scoreboard-ultra, .fcx-chip, .fcx-cta, .fcx-ticker, .fcx-sponsor-list li { forced-color-adjust: auto; border: 1px solid CanvasText; background: Canvas; color: CanvasText; }
  .fcx-cta-primary { background: Highlight; color: HighlightText; }
}
@media (min-width: 1024px) { .impact-right { position: sticky; top: 6rem; align-self: start; } }

/* ==== Optional: SaaS Flex/Level Up Ideas ==== */
/* - Add .fcx-scoreboard-ultra.premium { border-width:2.5px; box-shadow:0 12px 56px #facc1544, 0 2px 32px #22d3ee22; } */
/* - Animate avatars: .fcx-avatar { transition: transform .18s cubic-bezier(.4,0,.2,1); } */
/* - Add .fcx-chip.vip { border:2px solid #facc15; background:#fffbe0; color:#161600; } */
/* - Partner logo: .fcx-powered::after { content: url('/static/images/powered-logo.svg'); margin-left: .5em; vertical-align:middle; } */
</style>


<script {{ nonce_attr() }} type="module">
(() => {
  // === MULTI-INSTANCE SAFE ===
  const roots = Array.from(document.querySelectorAll('.fcx-scoreboard-ultra')).filter(r => !r.__wired);
  if (!roots.length) return;

  // === Utility functions ===
  const raf = (fn) => (window.requestAnimationFrame || ((f) => setTimeout(f,16)))(fn);
  const clamp = (n, a, b) => Math.max(a, Math.min(b, n));

  roots.forEach((root) => {
    if (root.__wired) return; root.__wired = true;

    // === Per-instance selectors/IDs ===
    const id = root.id || 'fcx-scoreboard-ultra';
    const $ = (sel) => root.querySelector(sel);
    const by = (suffix) => root.querySelector(`#${id}-${suffix}`);

    // === Data/config (locale, currency, etc.) ===
    const LOCALE = root.dataset.locale || 'en-US';
    const CURR = root.dataset.currency || 'USD';
    const fmt = (n) => { 
      try { return new Intl.NumberFormat(LOCALE, { style: 'currency', currency: CURR, maximumFractionDigits: 0 }).format(n); }
      catch { return '$' + Math.round(n).toLocaleString(); }
    };

    let GOAL = Math.max(1, Number(root.dataset.goal || 0));
    let RAISED = Math.max(0, Number(root.dataset.raised || 0));

    // === DOM Elements ===
    const ringFG    = $('.ring-fg');
    const pctLarge  = by('pct-large'), pctInline = by('pct-inline');
    const raisedEl  = by('raised'), goalEl = by('goal'), fill = $('.fcx-meter-fill'), gap = by('gap');
    const chips     = Array.from(root.querySelectorAll('.fcx-chip'));
    const donateBtn = by('donate-btn'), monthly = by('monthly'), prBtn = by('pr');
    const tTrack    = by('ticker-track'), tPause = by('ticker-pause');
    const sponsors  = by('sponsors'), deadline = by('deadline');

    // === LocalStorage keys, per instance ===
    const k = (name) => `fcx:${id}:${name}`;
    let selected = Number(localStorage.getItem(k('amt')) || 0) || null;
    let wantsMonthly = localStorage.getItem(k('monthly')) === '1';

    const pct = () => clamp((RAISED / GOAL) * 100, 0, 100);

    // === Render all dynamic parts ===
    function paint() {
      if (raisedEl)  raisedEl.textContent = fmt(RAISED);
      if (goalEl)    goalEl.textContent = fmt(GOAL);
      const p = Math.round(pct());
      if (pctLarge)  pctLarge.textContent = p + '%';
      if (pctInline) pctInline.textContent = p;
      if (fill)      raf(() => { fill.style.width = p + '%'; });
      if (ringFG) {
        const len = ringFG.getTotalLength ? ringFG.getTotalLength() : (2 * Math.PI * (ringFG.r?.baseVal?.value || 52));
        ringFG.style.strokeDasharray = len;
        ringFG.style.strokeDashoffset = String(len - len * p / 100);
      }
      const gapVal = Math.max(0, GOAL - RAISED);
      if (gap) gap.textContent = gapVal> 0 ? `Only ${fmt(gapVal)} to go!` : 'Goal reached ‚Äî thank you!';
    }

    // === Chips ===
    chips.forEach(b => b.addEventListener('click', () => {
      selected = Number(b.dataset.amt || 0) || selected;
      chips.forEach(x => x.setAttribute('aria-pressed', x === b ? 'true' : 'false'));
      try { localStorage.setItem(k('amt'), String(selected || '')); } catch {}
    }, { passive: true }));

    // === Monthly toggle ===
    if (monthly) monthly.addEventListener('change', () => {
      wantsMonthly = !!monthly.checked;
      try { localStorage.setItem(k('monthly'), wantsMonthly ? '1' : '0'); } catch {}
    });

    // === Checkout / Donate ===
    async function go(amount, monthlyFlag) {
      const BASE = root.dataset.donateUrl || '/donate', CHECKOUT = root.dataset.checkout || '';
      const TEAM = root.dataset.team || '';
      const safe = Math.max(1, Math.round(amount || 0));
      // Stripe/PayPal endpoint support
      if (CHECKOUT) {
        try {
          const r = await fetch(CHECKOUT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ amount: safe, team: TEAM, interval: monthlyFlag ? 'month' : 'one_time' })
          });
          const j = await r.json(); if (j?.url) { location.href = j.url; return; }
        } catch { /* fallback below */ }
      }
      // Fallback: regular /donate?amount=... route
      const u = new URL(BASE, location.origin);
      if (TEAM) u.searchParams.set('team', TEAM);
      if (safe) u.searchParams.set('amount', String(safe));
      if (monthlyFlag) u.searchParams.set('interval', 'month');
      location.assign(u.toString());
    }

    if (donateBtn) donateBtn.addEventListener('click', (e) => {
      e.preventDefault();
      const fallback = Number(chips[0]?.dataset.amt || 50);
      go(selected || fallback, monthly && monthly.checked);
    }, { passive: true });

    // Apple/Google Wallet (if supported)
    if (isSecureContext && 'PaymentRequest' in window && prBtn) {
      prBtn.hidden = false;
      prBtn.addEventListener('click', () => go(selected || 50, monthly && monthly.checked), { passive: true });
    }

    // === Ticker Animation / Pause ===
    let x = 0, paused = false;
    const reduce = matchMedia('(prefers-reduced-motion: reduce)').matches;
    if (tPause) tPause.addEventListener('click', () => { paused = !paused; tPause.setAttribute('aria-pressed', paused ? 'true' : 'false'); });
    (function anim() {
      if (!reduce && !paused && tTrack) { x -= 0.45; tTrack.style.transform = `translateX(${x}px)`; if (Math.abs(x)> (tTrack.scrollWidth / 2)) x = 0; }
      raf(anim);
    })();

    // === Deadline Countdown (hourly update) ===
    (function deadlineTick() {
      const el = deadline, iso = el?.getAttribute('datetime');
      if (!iso) return;
      const end = new Date(iso); if (isNaN(end)) return;
      const tick = () => {
        const ms = Math.max(0, end - new Date());
        const d = Math.floor(ms / 86400000), h = Math.floor((ms % 86400000) / 3600000);
        el.textContent = ms> 0 ? `${d}d ${h}h` : 'Ended';
      };
      tick(); setInterval(tick, 3_600_000);
    })();

    // === Leaderboard: Poll for updates ===
    async function loadLeaderboard() {
      const src = root.dataset.leaderboardSrc || '';
      if (!src) { sponsors?.setAttribute('aria-busy', 'false'); return; }
      try {
        const r = await fetch(src, { headers: { accept: 'application/json' }, cache: 'no-store' }); if (!r.ok) throw 0;
        const d = await r.json();
        sponsors.innerHTML = (Array.isArray(d) && d.length
          ? d.slice(0, 6).map((s, i) =>
            `<li><span>${i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : 'üèÖ'} ${s.name || 'Sponsor'}</span><strong>${fmt(s.amount || 0)}</strong></li>`
          ).join('')
          : '<li class="skeleton">No sponsors yet ‚Äî be the first!</li>'
        );
      } catch { /* keep skeleton */ }
      finally { sponsors?.setAttribute('aria-busy', 'false'); }
    }

    // === Totals/Progress: Poll for updates ===
    async function refreshTotals() {
      const url = root.dataset.totalsSrc || '/api/fund/totals';
      try {
        const r = await fetch(url, { cache: 'no-store', headers: { accept: 'application/json' } }); if (!r.ok) throw 0;
        const j = await r.json();
        if (typeof j.goal === 'number')   GOAL = Math.max(1, Number(j.goal));
        if (typeof j.raised === 'number') RAISED = Math.max(0, Number(j.raised));
        paint();
      } catch {}
    }

    // === Initial Render & Poll every minute ===
    paint(); loadLeaderboard(); refreshTotals();
    setInterval(() => { loadLeaderboard(); refreshTotals(); }, 60000);

    // === Level Up Ideas ===
    // TODO: Add WebSocket support for real-time progress!
    // TODO: Add animation on donation received (pulse ring, pop avatar)
    // TODO: Add ‚Äúcopy link‚Äù or ‚Äúshare to social‚Äù for viral fundraising
    // TODO: Accessibility: announce progress updates via ARIA live region

  }); // END roots.forEach
})();
</script>

